<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🦑 CANDY SQUID - Squid Game Ortiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #gameContainer {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        #instructionsScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            text-align: center;
        }

        #gameTitle {
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 30px #FFD700;
            margin-bottom: 30px;
        }

        #instructions {
            background: rgba(138, 43, 226, 0.2);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #8A2BE2;
            margin-bottom: 30px;
            max-width: 500px;
        }

        #instructions h3 {
            color: #FFD700;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        #instructions p {
            color: #9370DB;
            font-size: 1.1rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .gameButton {
            background: linear-gradient(45deg, #8A2BE2, #FFD700);
            color: #222;
            border: none;
            border-radius: 15px;
            padding: 15px 30px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', Arial, sans-serif;
            box-shadow: 0 0 30px rgba(138, 43, 226, 0.3);
            margin: 10px;
        }

        .gameButton:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(138, 43, 226, 0.5);
        }

        #gameScreen {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #gameHeader {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            z-index: 100;
        }

        #backButton {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', Arial, sans-serif;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
            margin-right: 15px;
        }

        #backButton:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.8);
        }

        #gameContent {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            width: 100%;
            max-width: 600px;
            margin-top: 60px;
        }

        #gameStats {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            margin-left: 100px;
        }

        .stat {
            background: rgba(138, 43, 226, 0.3);
            padding: 6px 10px;
            border-radius: 8px;
            border: 2px solid #8A2BE2;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5);
            text-align: center;
            min-width: 60px;
        }

        .stat-label {
            font-size: 0.6rem;
            color: #9370DB;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: #FFD700;
        }

        #gameBoard {
            width: 350px;
            height: 350px;
            background: rgba(138, 43, 226, 0.1);
            border: 3px solid #8A2BE2;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(138, 43, 226, 0.5);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 3px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .candy {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.2);
            border: 2px solid transparent;
        }

        .candy:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px currentColor, inset 0 0 20px rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .candy.selected {
            transform: scale(1.2);
            box-shadow: 0 0 35px currentColor, inset 0 0 25px rgba(255, 255, 255, 0.4);
            border: 3px solid #fff;
            animation: selectedPulse 0.8s ease-in-out infinite;
        }

        @keyframes selectedPulse {
            0%, 100% { 
                box-shadow: 0 0 35px currentColor, inset 0 0 25px rgba(255, 255, 255, 0.4);
                transform: scale(1.2);
            }
            50% { 
                box-shadow: 0 0 55px currentColor, inset 0 0 35px rgba(255, 255, 255, 0.6);
                transform: scale(1.25);
            }
        }

        .candy.matched {
            animation: disappear 0.6s ease-in-out forwards;
        }

        @keyframes disappear {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        /* Candy types */
        .candy-squid { 
            background: linear-gradient(45deg, #8A2BE2, #9370DB); 
            color: #fff; 
        }
        .candy-fish { 
            background: linear-gradient(45deg, #00CED1, #20B2AA); 
            color: #fff; 
        }
        .candy-coin { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            color: #000; 
        }
        .candy-mask { 
            background: linear-gradient(45deg, #FF4500, #FF6347); 
            color: #fff; 
        }
        .candy-circle { 
            background: linear-gradient(45deg, #32CD32, #228B22); 
            color: #fff; 
        }
        .candy-triangle { 
            background: linear-gradient(45deg, #FF69B4, #FF1493); 
            color: #fff; 
        }
        .candy-square { 
            background: linear-gradient(45deg, #4169E1, #1E90FF); 
            color: #fff; 
        }
        .candy-star { 
            background: linear-gradient(45deg, #FFD700, #FFA500); 
            color: #000; 
        }

        #gameOver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        #gameOver h2 {
            font-size: 3rem;
            color: #FFD700;
            margin-bottom: 30px;
            text-align: center;
            text-shadow: 0 0 30px #FFD700;
        }

        #finalScore, #finalCoins {
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            #gameContainer {
                padding: 10px;
            }

            #gameHeader {
                top: 10px;
                left: 10px;
                right: 10px;
            }

            #backButton {
                padding: 8px 15px;
                font-size: 0.9rem;
                margin-right: 10px;
            }

            #gameTitle {
                font-size: 2rem;
            }

            #gameContent {
                margin-top: 50px;
            }

            #gameStats {
                gap: 6px;
                margin-bottom: 15px;
                margin-left: 80px;
            }

            #instructions h3 {
                font-size: 1.2rem;
            }

            #instructions p {
                font-size: 1rem;
            }

            #gameBoard {
                width: 300px;
                height: 300px;
                padding: 12px;
            }

            .candy {
                font-size: 1.5rem;
            }

            .stat {
                padding: 5px 8px;
                min-width: 50px;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            .stat-value {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            #gameTitle {
                font-size: 1.5rem;
            }

            #gameContent {
                margin-top: 40px;
            }

            #gameStats {
                margin-left: 60px;
            }

            #gameBoard {
                width: 280px;
                height: 280px;
                padding: 10px;
            }

            .candy {
                font-size: 1.3rem;
            }

            .stat {
                padding: 4px 6px;
                min-width: 45px;
            }

            .stat-label {
                font-size: 0.6rem;
            }

            .stat-value {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Pantalla de instrucciones -->
        <div id="instructionsScreen">
            <h1 id="gameTitle">🦑 CANDY SQUID</h1>
            
            <div id="instructions">
                <h3>🎯 ¿Cómo jugar?</h3>
                <p>• Haz coincidir 3 o más caramelos iguales</p>
                <p>• Toca un caramelo y luego otro adyacente para intercambiarlos</p>
                <p>• En móvil: desliza para intercambiar caramelos</p>
                <p>• Consigue puntuación alta para ganar monedas</p>
                <p>• Cada 1000 puntos subes de nivel</p>
            </div>

            <button class="gameButton" onclick="startGame()">🎮 EMPEZAR A JUGAR</button>
            <button class="gameButton" onclick="goBack()">🔙 VOLVER</button>
        </div>

        <!-- Pantalla del juego -->
        <div id="gameScreen">
            <div id="gameHeader">
                <button id="backButton" onclick="goBack()">🔙 VOLVER</button>
            </div>

            <div id="gameContent">
                            <div id="gameStats">
                <div class="stat">
                    <div class="stat-label">NIVEL</div>
                    <div class="stat-value" id="level">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">MONEDAS</div>
                    <div class="stat-value" id="coins">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">MOVIMIENTOS</div>
                    <div class="stat-value" id="moves">0</div>
                </div>
            </div>

                <div id="gameBoard"></div>

                <button class="gameButton" onclick="restartGame()">🔄 REINICIAR</button>
            </div>
        </div>

        <div id="gameOver">
            <h2>🎮 ¡JUEGO TERMINADO!</h2>
            <div id="finalCoins">MONEDAS GANADAS: 0</div>
            <button class="gameButton" onclick="restartGame()">🔄 JUGAR DE NUEVO</button>
            <button class="gameButton" onclick="goBack()">🔙 VOLVER</button>
        </div>
    </div>

    <script>
        // Game variables
        let board = [];
        let selectedCandy = null;
        let score = 0;
        let coins = 0;
        let moves = 0;
        let level = 1;
        let targetScore = 1000;
        let gameRunning = true;
        let boardSize = 8;
        let coinsAddedToTotal = false;

        // Candy types
        const candyTypes = [
            { emoji: '🦑', class: 'candy-squid', value: 10 },
            { emoji: '🐟', class: 'candy-fish', value: 8 },
            { emoji: '💰', class: 'candy-coin', value: 15 },
            { emoji: '🎭', class: 'candy-mask', value: 12 },
            { emoji: '⭕', class: 'candy-circle', value: 6 },
            { emoji: '🔺', class: 'candy-triangle', value: 7 },
            { emoji: '⬜', class: 'candy-square', value: 5 },
            { emoji: '⭐', class: 'candy-star', value: 20 }
        ];

        // Start game function
        function startGame() {
            document.getElementById('instructionsScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            initGame();
        }

        // Initialize game
        function initGame() {
            createBoard();
            renderBoard();
            updateUI();
            addTouchListeners();
        }

        // Create initial board
        function createBoard() {
            board = [];
            for (let row = 0; row < boardSize; row++) {
                board[row] = [];
                for (let col = 0; col < boardSize; col++) {
                    board[row][col] = getRandomCandy();
                }
            }
            
            // Ensure no initial matches
            while (findMatches().length > 0) {
                for (let row = 0; row < boardSize; row++) {
                    for (let col = 0; col < boardSize; col++) {
                        board[row][col] = getRandomCandy();
                    }
                }
            }
        }

        // Get random candy type
        function getRandomCandy() {
            return candyTypes[Math.floor(Math.random() * candyTypes.length)];
        }

        // Render board
        function renderBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';

            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    const candy = document.createElement('div');
                    candy.className = `candy ${board[row][col].class}`;
                    candy.textContent = board[row][col].emoji;
                    candy.dataset.row = row;
                    candy.dataset.col = col;
                    candy.addEventListener('click', () => selectCandy(row, col));
                    gameBoard.appendChild(candy);
                }
            }
        }

        // Select candy
        function selectCandy(row, col) {
            if (!gameRunning) return;

            const candy = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            
            if (selectedCandy) {
                document.querySelector('.candy.selected')?.classList.remove('selected');
                
                const selectedRow = parseInt(selectedCandy.dataset.row);
                const selectedCol = parseInt(selectedCandy.dataset.col);
                
                if (isAdjacent(selectedRow, selectedCol, row, col)) {
                    swapCandies(selectedRow, selectedCol, row, col);
                    selectedCandy = null;
                } else {
                    selectedCandy = candy;
                    candy.classList.add('selected');
                }
            } else {
                selectedCandy = candy;
                candy.classList.add('selected');
            }
        }

        // Check if two positions are adjacent
        function isAdjacent(row1, col1, row2, col2) {
            return (Math.abs(row1 - row2) === 1 && col1 === col2) ||
                   (Math.abs(col1 - col2) === 1 && row1 === row2);
        }

        // Swap candies
        function swapCandies(row1, col1, row2, col2) {
            const candy1 = document.querySelector(`[data-row="${row1}"][data-col="${col1}"]`);
            const candy2 = document.querySelector(`[data-row="${row2}"][data-col="${col2}"]`);
            
            if (candy1 && candy2) {
                candy1.style.transform = 'scale(1.1)';
                candy2.style.transform = 'scale(1.1)';
                
                setTimeout(() => {
                    const temp = board[row1][col1];
                    board[row1][col1] = board[row2][col2];
                    board[row2][col2] = temp;

                    const matches = findMatches();
                    
                    if (matches.length > 0) {
                        moves++;
                        processMatches(matches);
                    } else {
                        const temp = board[row1][col1];
                        board[row1][col1] = board[row2][col2];
                        board[row2][col2] = temp;
                        
                        candy1.style.transform = 'scale(0.9)';
                        candy2.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            candy1.style.transform = '';
                            candy2.style.transform = '';
                        }, 200);
                    }

                    selectedCandy = null;
                    updateUI();
                }, 150);
            }
        }

        // Find all matches
        function findMatches() {
            const matches = [];

            // Check horizontal matches
            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize - 2; col++) {
                    if (board[row][col] && 
                        board[row][col].emoji === board[row][col + 1].emoji &&
                        board[row][col].emoji === board[row][col + 2].emoji) {
                        
                        const match = [];
                        for (let i = col; i < boardSize && board[row][i].emoji === board[row][col].emoji; i++) {
                            match.push({row, col: i});
                        }
                        matches.push(match);
                    }
                }
            }

            // Check vertical matches
            for (let row = 0; row < boardSize - 2; row++) {
                for (let col = 0; col < boardSize; col++) {
                    if (board[row][col] && 
                        board[row][col].emoji === board[row + 1][col].emoji &&
                        board[row][col].emoji === board[row + 2][col].emoji) {
                        
                        const match = [];
                        for (let i = row; i < boardSize && board[i][col].emoji === board[row][col].emoji; i++) {
                            match.push({row: i, col});
                        }
                        matches.push(match);
                    }
                }
            }

            return matches;
        }

        // Process matches
        function processMatches(matches) {
            const matchedPositions = new Set();
            
            matches.forEach(match => {
                match.forEach(pos => {
                    matchedPositions.add(`${pos.row},${pos.col}`);
                });
            });

            matchedPositions.forEach(posStr => {
                const [row, col] = posStr.split(',').map(Number);
                const candy = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                if (candy) {
                    candy.classList.add('matched');
                }
            });

            const totalMatched = matchedPositions.size;
            const matchCoins = totalMatched * 10;
            
            score += totalMatched * 100;
            coins += matchCoins;

            setTimeout(() => {
                removeMatchedCandies(matchedPositions);
                fillBoard();
                renderBoard();
                updateUI();
                
                setTimeout(() => {
                    const newMatches = findMatches();
                    if (newMatches.length > 0) {
                        processMatches(newMatches);
                    }
                }, 300);
            }, 600);
        }

        // Remove matched candies
        function removeMatchedCandies(matchedPositions) {
            matchedPositions.forEach(posStr => {
                const [row, col] = posStr.split(',').map(Number);
                board[row][col] = null;
            });
        }

        // Fill board with new candies
        function fillBoard() {
            for (let col = 0; col < boardSize; col++) {
                let emptyRow = boardSize - 1;
                for (let row = boardSize - 1; row >= 0; row--) {
                    if (board[row][col] !== null) {
                        if (row !== emptyRow) {
                            board[emptyRow][col] = board[row][col];
                            board[row][col] = null;
                        }
                        emptyRow--;
                    }
                }
            }

            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    if (board[row][col] === null) {
                        board[row][col] = getRandomCandy();
                    }
                }
            }
        }

        // Update UI
        function updateUI() {
            document.getElementById('level').textContent = level;
            document.getElementById('coins').textContent = coins;
            document.getElementById('moves').textContent = moves;

            if (score >= targetScore) {
                levelUp();
            }
        }

        // Level up
        function levelUp() {
            level++;
            targetScore = level * 1000;
            
            const levelUpDiv = document.createElement('div');
            levelUpDiv.style.position = 'fixed';
            levelUpDiv.style.top = '50%';
            levelUpDiv.style.left = '50%';
            levelUpDiv.style.transform = 'translate(-50%, -50%)';
            levelUpDiv.style.background = 'linear-gradient(45deg, #FFD700, #FFA500)';
            levelUpDiv.style.color = '#000';
            levelUpDiv.style.padding = '20px 40px';
            levelUpDiv.style.borderRadius = '15px';
            levelUpDiv.style.fontSize = '2rem';
            levelUpDiv.style.fontWeight = 'bold';
            levelUpDiv.style.zIndex = '150';
            levelUpDiv.style.textAlign = 'center';
            levelUpDiv.style.boxShadow = '0 0 50px #FFD700';
            levelUpDiv.textContent = `🎉 NIVEL ${level}! 🎉`;
            document.body.appendChild(levelUpDiv);
            
            setTimeout(() => {
                levelUpDiv.remove();
            }, 3000);
        }

        // Game over
        function gameOver() {
            gameRunning = false;
            document.getElementById('finalCoins').textContent = `MONEDAS GANADAS: +${coins}`;
            document.getElementById('gameOver').style.display = 'flex';
        }

        // Add coins to total
        function addCoinsToTotal() {
            if (coinsAddedToTotal || coins <= 0) return;
            coinsAddedToTotal = true;
            if (window.PlayerDataManager && PlayerDataManager.safeAddCoins) {
                const success = PlayerDataManager.safeAddCoins(coins, 'candy-squid');
                if (success) {
                    console.log(`✅ Candy Squid coins added safely: +${coins}`);
                } else {
                    addCoinsFallback(coins);
                }
            } else {
                addCoinsFallback(coins);
            }
        }

        function addCoinsFallback(coinsToAdd) {
            try {
                const currentCoins = parseInt(localStorage.getItem('totalOrtizCoins') || '0');
                const newCoins = currentCoins + coinsToAdd;
                localStorage.setItem('totalOrtizCoins', newCoins.toString());
                if (window.firebase && window.firebase.database) {
                    const playerName = localStorage.getItem('playerName') || 'Jugador';
                    const userRef = window.firebase.database().ref(`users/${playerName}`);
                    userRef.update({
                        totalOrtizCoins: newCoins,
                        candySquidWins: (parseInt(localStorage.getItem('candySquidWins') || '0') + 1).toString()
                    });
                }
                console.log(`✅ Candy Squid coins added: ${currentCoins} -> ${newCoins}`);
            } catch (error) {
                console.error('❌ Error adding Candy Squid coins:', error);
            }
        }

        // Restart game
        function restartGame() {
            score = 0;
            coins = 0;
            moves = 0;
            level = 1;
            targetScore = 1000;
            gameRunning = true;
            selectedCandy = null;
            coinsAddedToTotal = false;
            
            document.getElementById('gameOver').style.display = 'none';
            createBoard();
            renderBoard();
            updateUI();
        }

        // Go back to main menu
        function goBack() {
            addCoinsToTotal();
            window.location.href = 'index.html';
        }

        // Add touch event listeners for mobile
        function addTouchListeners() {
            const gameBoard = document.getElementById('gameBoard');
            
            let isDragging = false;
            let startCandy = null;
            let lastTouchX = 0;
            let lastTouchY = 0;
            
            gameBoard.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
                
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element && element.classList.contains('candy')) {
                    isDragging = true;
                    startCandy = element;
                    
                    const row = parseInt(element.dataset.row);
                    const col = parseInt(element.dataset.col);
                    selectCandy(row, col);
                }
            }, { passive: false });
            
            gameBoard.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (isDragging && startCandy && selectedCandy) {
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - lastTouchX;
                    const deltaY = touch.clientY - lastTouchY;
                    
                    if (Math.abs(deltaX) > 20 || Math.abs(deltaY) > 20) {
                        const startRow = parseInt(startCandy.dataset.row);
                        const startCol = parseInt(startCandy.dataset.col);
                        
                        let targetRow = startRow;
                        let targetCol = startCol;
                        
                        if (Math.abs(deltaX) > Math.abs(deltaY)) {
                            if (deltaX > 0 && startCol < boardSize - 1) {
                                targetCol = startCol + 1;
                            } else if (deltaX < 0 && startCol > 0) {
                                targetCol = startCol - 1;
                            }
                        } else {
                            if (deltaY > 0 && startRow < boardSize - 1) {
                                targetRow = startRow + 1;
                            } else if (deltaY < 0 && startRow > 0) {
                                targetRow = startRow - 1;
                            }
                        }
                        
                        if (targetRow !== startRow || targetCol !== startCol) {
                            swapCandies(startRow, startCol, targetRow, targetCol);
                            isDragging = false;
                            startCandy = null;
                        }
                    }
                    
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                }
            }, { passive: false });
            
            gameBoard.addEventListener('touchend', (e) => {
                isDragging = false;
                startCandy = null;
            }, { passive: false });
        }
    </script>
</body>
</html> 