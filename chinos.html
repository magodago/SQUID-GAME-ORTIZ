<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinos - Squid Game</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .chinos-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            text-align: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .number-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .number-buttons {
                gap: 8px;
                margin: 10px 0;
            }
        }
        .number-btn {
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        @media (max-width: 768px) {
            .number-btn {
                padding: 12px;
                font-size: 18px;
                min-height: 50px;
            }
        }
        .number-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        .number-btn.selected {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border-color: #4ecdc4;
        }
        .guess-input {
            margin: 20px 0;
        }
        .guess-input input {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            text-align: center;
            width: 120px;
            min-height: 50px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        @media (max-width: 768px) {
            .guess-input input {
                padding: 12px;
                font-size: 16px;
                width: 100px;
                min-height: 45px;
            }
        }
        .submit-btn {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 50px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (max-width: 768px) {
            .submit-btn {
                padding: 12px 25px;
                font-size: 16px;
                min-height: 45px;
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
            }
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .players-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .player-card {
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #ff6b6b;
        }
        .player-card.ready {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
        .countdown {
            font-size: 48px;
            font-weight: bold;
            color: #ff6b6b;
            margin: 20px 0;
        }
        .results {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        .winner {
            color: #4ecdc4;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .loser {
            color: #ff6b6b;
            font-size: 18px;
            margin: 5px 0;
        }
        .total-sum {
            font-size: 36px;
            font-weight: bold;
            color: #ffd93d;
            margin: 15px 0;
        }
        .back-btn {
            margin-top: 20px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        /* Animaciones para notificaciones */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="chinos-container">
        <h1>üé≤ Chinos</h1>
        <p>Selecciona un n√∫mero y adivina la suma total</p>

        <div id="waiting-room" class="game-phase">
            <h2>Sala de Espera</h2>
            <div id="players-list" class="players-status"></div>
            <div id="countdown" class="countdown"></div>
        </div>

        <div id="number-selection" class="game-phase" style="display: none;">
            <h2>Selecciona tu n√∫mero</h2>
            <div class="number-buttons">
                <button class="number-btn" data-number="1">1</button>
                <button class="number-btn" data-number="2">2</button>
                <button class="number-btn" data-number="3">3</button>
                <button class="number-btn" data-number="4">4</button>
            </div>
            <div class="guess-input">
                <label for="guess">Tu predicci√≥n de la suma total:</label><br>
                <input type="number" id="guess" min="2" max="16" placeholder="Ej: 5">
            </div>
            <button id="submit-choice" class="submit-btn" disabled>Confirmar</button>
        </div>

        <div id="results" class="game-phase" style="display: none;">
            <h2>Resultados</h2>
            <div id="results-content"></div>
            <button class="back-btn" onclick="window.location.href='index.html'">Volver al Men√∫</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBZTHdGwNjqBy6TZmpMJTKoac9GIPIObp0",
            authDomain: "squid-game-ortiz.firebaseapp.com",
            databaseURL: "https://squid-game-ortiz-default-rtdb.firebaseio.com",
            projectId: "squid-game-ortiz",
            storageBucket: "squid-game-ortiz.firebasestorage.app",
            messagingSenderId: "564790427576",
            appId: "1:564790427576:web:585ed1ec3d9dea792a594d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('gameId');
        const playerId = urlParams.get('playerId') || 'player_' + Date.now();
        const playerName = localStorage.getItem('soldierName') || 'Jugador';

        if (!gameId) {
            alert('Error: No se encontr√≥ el ID del juego');
            window.location.href = 'index.html';
        }

        const gameRef = ref(db, `chinos/${gameId}`);
        const playersRef = ref(db, `chinos/${gameId}/players`);
        const gameStateRef = ref(db, `chinos/${gameId}/gameState`);

        // Variables para manejar la creaci√≥n autom√°tica de salas
        let roomCreationAttempts = 0;
        const maxRoomCreationAttempts = 3;
        let roomCreationTimeout = null;

        let selectedNumber = null;
        let myGuess = null;
        let countdownInterval = null;

        const waitingRoom = document.getElementById('waiting-room');
        const numberSelection = document.getElementById('number-selection');
        const results = document.getElementById('results');
        const playersList = document.getElementById('players-list');
        const countdownElement = document.getElementById('countdown');
        const submitBtn = document.getElementById('submit-choice');
        const guessInput = document.getElementById('guess');

        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type = 'info') {
            console.log(`üì¢ Notificaci√≥n [${type}]: ${message}`);
            
            // Crear notificaci√≥n visual
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }

        function initializePlayer() {
            const playerData = {
                id: playerId,
                name: playerName,
                online: true,
                ready: false,
                selectedNumber: null,
                guess: null
            };

            console.log('üë§ Inicializando jugador:', playerData);
            
            set(ref(db, `chinos/${gameId}/players/${playerId}`), playerData)
                .then(() => {
                    console.log('‚úÖ Jugador inicializado exitosamente en Firebase');
                })
                .catch((error) => {
                    console.error('‚ùå Error al inicializar jugador:', error);
                });
        }

        onValue(gameStateRef, (snapshot) => {
            const gameState = snapshot.val();
            console.log('üéÆ Estado del juego recibido:', gameState);
            
            if (!gameState) {
                console.log('‚ùå No hay estado del juego, intentando crear sala...');
                // Si no existe el estado del juego, intentar crear la sala autom√°ticamente
                if (roomCreationAttempts < maxRoomCreationAttempts) {
                    roomCreationAttempts++;
                    console.log(`üîÑ Intento ${roomCreationAttempts}/${maxRoomCreationAttempts}: Creando sala de juego Chinos autom√°ticamente`);
                    
                    if (roomCreationTimeout) {
                        clearTimeout(roomCreationTimeout);
                    }
                    
                    roomCreationTimeout = setTimeout(() => {
                        createGameRoom();
                    }, 1000 * roomCreationAttempts);
                } else {
                    console.log('‚ùå No se pudo crear la sala de juego despu√©s de varios intentos');
                    alert('Error: No se pudo conectar a la sala de juego. Intenta de nuevo.');
                    window.location.href = 'index.html';
                }
                return;
            }

            console.log('‚úÖ Estado del juego actualizado:', gameState);

            switch (gameState.phase) {
                case 'waiting':
                    showWaitingRoom();
                    startCountdown(gameState.countdown);
                    break;
                case 'playing':
                    showNumberSelection();
                    break;
                case 'results':
                    showResults(gameState);
                    break;
            }
        });

        onValue(playersRef, (snapshot) => {
            const players = snapshot.val();
            if (!players) return;

            updatePlayersList(players);
            checkGameStart(players);
            
            // Verificar si todos los jugadores est√°n listos para calcular resultados
            const onlinePlayers = Object.values(players).filter(p => p.online);
            const readyPlayers = onlinePlayers.filter(p => p.ready && p.selectedNumber && p.guess);
            
            if (onlinePlayers.length >= 2 && readyPlayers.length === onlinePlayers.length) {
                // Todos los jugadores est√°n listos, calcular resultados
                console.log('üéØ Todos los jugadores est√°n listos, calculando resultados...');
                calculateResults();
            }
        });

        function showWaitingRoom() {
            waitingRoom.style.display = 'block';
            numberSelection.style.display = 'none';
            results.style.display = 'none';
        }

        function showNumberSelection() {
            console.log('üéØ Mostrando selecci√≥n de n√∫meros');
            waitingRoom.style.display = 'none';
            numberSelection.style.display = 'block';
            results.style.display = 'none';
        }

        function showResults(gameState) {
            waitingRoom.style.display = 'none';
            numberSelection.style.display = 'none';
            results.style.display = 'block';

            const resultsContent = document.getElementById('results-content');
            const totalSum = gameState.totalSum;
            const winner = gameState.winner;

            let html = `<div class="total-sum">Suma Total: ${totalSum}</div>`;
            
            Object.values(gameState.players).forEach(player => {
                const isWinner = player.id === winner;
                const status = isWinner ? 'winner' : 'loser';
                const icon = isWinner ? 'üèÜ' : 'üíÄ';
                const playerName = player.name || 'Jugador Desconocido';
                
                html += `
                    <div class="${status}">
                        ${icon} ${playerName}: Seleccion√≥ ${player.selectedNumber}, 
                        predijo ${player.guess} 
                        ${isWinner ? '(GANADOR!)' : ''}
                    </div>
                `;
            });

            resultsContent.innerHTML = html;

            if (winner === playerId) {
                addCoins(1000);
                console.log('¬°Ganaste! +1000 monedas');
            } else {
                subtractCoins(500);
                console.log('Perdiste -500 monedas');
            }
        }

        function updatePlayersList(players) {
            playersList.innerHTML = '';
            
            Object.values(players).forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.ready ? 'ready' : ''}`;
                
                const playerName = player.name || 'Jugador Desconocido';
                const status = player.online ? 'üü¢ Online' : 'üî¥ Offline';
                const readyStatus = player.ready ? '‚úÖ Listo' : '‚è≥ Esperando';
                
                playerCard.innerHTML = `
                    <h3>${playerName}</h3>
                    <p>Estado: ${status}</p>
                    <p>${readyStatus}</p>
                    ${player.selectedNumber ? `<p>N√∫mero: ${player.selectedNumber}</p>` : ''}
                    ${player.guess ? `<p>Predicci√≥n: ${player.guess}</p>` : ''}
                `;
                
                playersList.appendChild(playerCard);
            });
            
            console.log('üë• Lista de jugadores actualizada:', players);
        }

        function checkGameStart(players) {
            const onlinePlayers = Object.values(players).filter(p => p.online);
            const readyPlayers = onlinePlayers.filter(p => p.ready);

            if (onlinePlayers.length >= 2 && readyPlayers.length === onlinePlayers.length) {
                if (!countdownInterval) {
                    startGameCountdown();
                }
            }
        }

        function startCountdown(initialCountdown) {
            let countdown = initialCountdown || 30;
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    startGame();
                }
                
                countdown--;
            }, 1000);
        }

        function startGameCountdown() {
            let countdown = 30;
            
            countdownInterval = setInterval(() => {
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    startGame();
                }
                
                countdown--;
            }, 1000);
        }

        function startGame() {
            set(gameStateRef, {
                phase: 'playing',
                startTime: Date.now()
            });
            
            // Verificar resultados inmediatamente y tambi√©n despu√©s de 60 segundos como respaldo
            calculateResults();
            setTimeout(() => {
                calculateResults();
            }, 60000);
        }

        function calculateResults() {
            onValue(playersRef, (snapshot) => {
                const players = snapshot.val();
                if (!players) {
                    console.log('‚ùå No hay jugadores para calcular resultados');
                    return;
                }

                const onlinePlayers = Object.values(players).filter(p => p.online && p.ready && p.selectedNumber && p.guess);
                console.log('üë• Jugadores online y listos:', onlinePlayers);
                
                if (onlinePlayers.length < 2) {
                    console.log('‚ùå No hay suficientes jugadores para calcular resultados');
                    return;
                }

                // Calcular suma total
                const totalSum = onlinePlayers.reduce((sum, player) => sum + player.selectedNumber, 0);
                console.log('üî¢ Suma total de n√∫meros seleccionados:', totalSum);
                
                // Mostrar las elecciones de cada jugador
                onlinePlayers.forEach(player => {
                    console.log(`üë§ ${player.name}: N√∫mero=${player.selectedNumber}, Predicci√≥n=${player.guess}`);
                });
                
                // Encontrar ganador (el que predijo correctamente la suma)
                const winner = onlinePlayers.find(player => player.guess === totalSum);
                console.log('üèÜ Ganador:', winner ? winner.name : 'Ninguno');
                
                const gameState = {
                    phase: 'results',
                    totalSum: totalSum,
                    winner: winner ? winner.id : null,
                    players: players,
                    endTime: Date.now()
                };

                set(gameStateRef, gameState);
                console.log('‚úÖ Resultados calculados y guardados:', gameState);
            }, { onlyOnce: true });
        }

        document.querySelectorAll('.number-btn').forEach(btn => {
            // Agregar eventos tanto para click como para touch
            const handleSelection = () => {
                console.log('üî¢ N√∫mero seleccionado:', btn.dataset.number);
                document.querySelectorAll('.number-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedNumber = parseInt(btn.dataset.number);
                checkSubmitButton();
                
                // Feedback t√°ctil
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    btn.style.transform = 'scale(1)';
                }, 150);
            };
            
            btn.addEventListener('click', handleSelection);
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleSelection();
            });
        });

        guessInput.addEventListener('input', () => {
            myGuess = parseInt(guessInput.value);
            console.log('üìù Predicci√≥n ingresada:', myGuess);
            checkSubmitButton();
        });
        
        // Mejorar experiencia en m√≥vil para el input
        guessInput.addEventListener('focus', () => {
            // Scroll suave hacia el input en m√≥vil
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    guessInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        });

        function checkSubmitButton() {
            const isValid = selectedNumber && myGuess && myGuess >= 2 && myGuess <= 16;
            submitBtn.disabled = !isValid;
            console.log('üîç Verificando bot√≥n:', { 
                selectedNumber, 
                myGuess, 
                isValid, 
                buttonDisabled: submitBtn.disabled,
                buttonText: submitBtn.textContent
            });
            
            // Mostrar estado visual del bot√≥n
            if (isValid) {
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
                submitBtn.textContent = '‚úÖ CONFIRMAR';
            } else {
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
                submitBtn.style.background = 'linear-gradient(135deg, #ccc, #999)';
                submitBtn.textContent = '‚è≥ Selecciona n√∫mero y predicci√≥n';
            }
            
            // Mostrar indicador de estado en m√≥vil
            if (window.innerWidth <= 768) {
                const statusIndicator = document.getElementById('mobile-status') || createMobileStatusIndicator();
                if (isValid) {
                    statusIndicator.textContent = '‚úÖ Listo para enviar';
                    statusIndicator.style.color = '#4ecdc4';
                } else {
                    statusIndicator.textContent = '‚è≥ Completa los datos';
                    statusIndicator.style.color = '#ff6b6b';
                }
            }
        }
        
        function createMobileStatusIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'mobile-status';
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 8px 15px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: bold;
                z-index: 1000;
                display: none;
            `;
            
            if (window.innerWidth <= 768) {
                indicator.style.display = 'block';
            }
            
            document.body.appendChild(indicator);
            return indicator;
        }

        const handleSubmit = () => {
            console.log('üîò Bot√≥n Confirmar clickeado');
            console.log('üìä Datos actuales:', { selectedNumber, myGuess, playerId, playerName });
            console.log('üéÆ Estado actual del bot√≥n:', { disabled: submitBtn.disabled, text: submitBtn.textContent });
            
            if (!selectedNumber || !myGuess) {
                console.log('‚ùå Datos faltantes:', { selectedNumber, myGuess });
                alert('Por favor selecciona un n√∫mero y ingresa tu predicci√≥n');
                return;
            }

            if (myGuess < 2 || myGuess > 16) {
                console.log('‚ùå Predicci√≥n fuera de rango:', myGuess);
                alert('La predicci√≥n debe estar entre 2 y 16');
                return;
            }

            console.log('‚úÖ Datos v√°lidos, enviando a Firebase...');

            // Deshabilitar bot√≥n inmediatamente para evitar doble clic
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            // Actualizar solo los campos necesarios sin sobrescribir datos existentes
            const updates = {};
            updates[`chinos/${gameId}/players/${playerId}/selectedNumber`] = selectedNumber;
            updates[`chinos/${gameId}/players/${playerId}/guess`] = myGuess;
            updates[`chinos/${gameId}/players/${playerId}/ready`] = true;
            updates[`chinos/${gameId}/players/${playerId}/name`] = playerName; // Mantener el nombre
            updates[`chinos/${gameId}/players/${playerId}/online`] = true; // Asegurar que est√© online

            console.log('üì§ Enviando actualizaciones:', updates);

            // Timeout m√°s largo para m√≥vil
            const timeoutDuration = window.innerWidth <= 768 ? 15000 : 10000;
            
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Timeout')), timeoutDuration);
            });
            
            Promise.race([
                set(ref(db), updates),
                timeoutPromise
            ])
                .then(() => {
                    console.log('‚úÖ Datos enviados exitosamente a Firebase');
                    submitBtn.textContent = 'Enviado ‚úì';
                    
                    // Mostrar confirmaci√≥n al usuario
                    showNotification('‚úÖ Elecci√≥n enviada correctamente', 'success');
                })
                .catch((error) => {
                    console.error('‚ùå Error al enviar datos:', error);
                    const errorMessage = error.message === 'Timeout' 
                        ? 'Tiempo de espera agotado. Verifica tu conexi√≥n e intenta de nuevo.'
                        : 'Error al enviar datos. Intenta de nuevo.';
                    alert(errorMessage);
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚úÖ CONFIRMAR';
                });
            
            console.log('Elecci√≥n enviada:', { selectedNumber, guess: myGuess, ready: true, name: playerName });
        };
        
        // Agregar eventos tanto para click como para touch
        submitBtn.addEventListener('click', handleSubmit);
        submitBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            handleSubmit();
        });

        function addCoins(amount) {
            const currentCoins = parseInt(localStorage.getItem('totalOrtizCoins') || '0');
            const newCoins = currentCoins + amount;
            localStorage.setItem('totalOrtizCoins', newCoins.toString());
            
            // Sync with Firebase using PlayerDataManager if available
            if (window.PlayerDataManager && window.PlayerDataManager.safeAddCoins) {
                window.PlayerDataManager.safeAddCoins(amount, 'chinos-game-win');
            } else {
                // Fallback to direct Firebase update
                const playerName = localStorage.getItem('soldierName');
                if (playerName && window.firebase && window.firebase.database) {
                    const db = window.firebase.database();
                    const playerRef = db.ref(`players/${playerName}`);
                    playerRef.update({
                        coins: newCoins,
                        lastUpdated: Date.now()
                    });
                }
            }
            
            // Update display if function exists
            if (typeof loadTotalCoins === 'function') {
                loadTotalCoins();
            }
        }

        function subtractCoins(amount) {
            const currentCoins = parseInt(localStorage.getItem('totalOrtizCoins') || '0');
            const newCoins = Math.max(0, currentCoins - amount);
            localStorage.setItem('totalOrtizCoins', newCoins.toString());
            
            // Sync with Firebase using PlayerDataManager if available
            if (window.PlayerDataManager && window.PlayerDataManager.safeDeductCoins) {
                window.PlayerDataManager.safeDeductCoins(amount, 'chinos-game-loss');
            } else {
                // Fallback to direct Firebase update
                const playerName = localStorage.getItem('soldierName');
                if (playerName && window.firebase && window.firebase.database) {
                    const db = window.firebase.database();
                    const playerRef = db.ref(`players/${playerName}`);
                    playerRef.update({
                        coins: newCoins,
                        lastUpdated: Date.now()
                    });
                }
            }
            
            // Update display if function exists
            if (typeof loadTotalCoins === 'function') {
                loadTotalCoins();
            }
        }

        function createGameRoom() {
            console.log('üèóÔ∏è Creando sala de juego Chinos autom√°ticamente');
            
            // Crear el estado inicial del juego
            set(gameStateRef, {
                phase: 'waiting',
                countdown: 30,
                startTime: null,
                autoCreated: true
            });
            
            // Crear la sala de juego en gameRooms
            const gameRoomRef = ref(db, `gameRooms/${gameId}`);
            set(gameRoomRef, {
                gameId: gameId,
                status: 'waiting',
                createdAt: Date.now(),
                autoCreated: true,
                game: 'chinos'
            });
            
            console.log('‚úÖ Sala de juego Chinos creada autom√°ticamente');
        }

        window.addEventListener('beforeunload', () => {
            remove(ref(db, `chinos/${gameId}/players/${playerId}`));
        });

        initializePlayer();
        
        // Verificar estado inicial del bot√≥n
        setTimeout(() => {
            console.log('üîç Estado inicial del bot√≥n:', {
                disabled: submitBtn.disabled,
                text: submitBtn.textContent,
                selectedNumber,
                myGuess
            });
            checkSubmitButton();
        }, 1000);
        
        // Inicializar estado del juego si no existe
        onValue(gameStateRef, (snapshot) => {
            const gameState = snapshot.val();
            if (!gameState) {
                console.log('üÜï Inicializando estado del juego Chinos');
                set(gameStateRef, {
                    phase: 'waiting',
                    countdown: 30,
                    startTime: null
                });
            }
        }, { onlyOnce: true });
        
        // Crear sala de juego autom√°ticamente si no existe
        const gameRoomRef = ref(db, `gameRooms/${gameId}`);
        onValue(gameRoomRef, (snapshot) => {
            const gameRoom = snapshot.val();
            if (!gameRoom) {
                console.log('üÜï Creando sala de juego Chinos autom√°ticamente');
                set(gameRoomRef, {
                    gameId: gameId,
                    status: 'waiting',
                    createdAt: Date.now(),
                    autoCreated: true,
                    game: 'chinos'
                });
            }
        }, { onlyOnce: true });
    </script>
</body>
</html> 