<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinos - Squid Game</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .chinos-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .number-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .number-btn {
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .number-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        .number-btn.selected {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border-color: #4ecdc4;
        }
        .guess-input {
            margin: 20px 0;
        }
        .guess-input input {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            text-align: center;
            width: 100px;
        }
        .submit-btn {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .players-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .player-card {
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #ff6b6b;
        }
        .player-card.ready {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
        .countdown {
            font-size: 48px;
            font-weight: bold;
            color: #ff6b6b;
            margin: 20px 0;
        }
        .results {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        .winner {
            color: #4ecdc4;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .loser {
            color: #ff6b6b;
            font-size: 18px;
            margin: 5px 0;
        }
        .total-sum {
            font-size: 36px;
            font-weight: bold;
            color: #ffd93d;
            margin: 15px 0;
        }
        .back-btn {
            margin-top: 20px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
    </style>
</head>
<body>
    <div class="chinos-container">
        <h1>ü§≤ Chinos</h1>
        <p>Selecciona un n√∫mero y adivina la suma total</p>

        <div id="waiting-room" class="game-phase">
            <h2>Sala de Espera</h2>
            <p id="waiting-message">‚è≥ Esperando jugadores para iniciar el juego...</p>
            <div id="players-list" class="players-status"></div>
            <div id="countdown" class="countdown"></div>
        </div>

        <div id="number-selection" class="game-phase" style="display: none;">
            <div id="score-display" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ff6b6b;">
                <h3 style="color: #ffd93d; margin-bottom: 10px;">üèÜ PUNTUACI√ìN</h3>
                <div id="players-score" style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                    <!-- Los puntajes se mostrar√°n aqu√≠ din√°micamente -->
                </div>
                <div style="text-align: center; margin-top: 10px; color: #4ecdc4; font-weight: bold;">
                    <span id="current-round">Ronda 1</span> de 3
                </div>
            </div>
            <h2>Selecciona tu n√∫mero</h2>
            <p id="game-status">üéÆ Selecciona tu n√∫mero y predicci√≥n</p>
            <div class="number-buttons">
                <button class="number-btn" data-number="0">0</button>
                <button class="number-btn" data-number="1">1</button>
                <button class="number-btn" data-number="2">2</button>
                <button class="number-btn" data-number="3">3</button>
            </div>
            <div class="guess-input">
                <label for="guess">Tu predicci√≥n de la suma total (0-18):</label><br>
                <input type="number" id="guess" min="0" max="18" placeholder="Ej: 5" inputmode="numeric" pattern="[0-9]*">
            </div>
            <div id="mobile-error" style="color: #ff6b6b; font-weight: bold; margin: 10px 0; display: none;"></div>
            <button id="submit-choice" class="submit-btn" disabled>Confirmar</button>
        </div>

        <div id="results" class="game-phase" style="display: none;">
            <h2>Resultados de la Ronda</h2>
            <div id="results-content"></div>
            <div id="round-buttons" style="margin-top: 20px;">
                <button id="next-round-btn" class="submit-btn" style="margin-right: 10px; display: none;">Siguiente Ronda</button>
                <button id="finish-game-btn" class="back-btn" style="display: none;">Finalizar Juego</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZTHdGwNjqBy6TZmpMJTKoac9GIPIObp0",
            authDomain: "squid-game-ortiz.firebaseapp.com",
            databaseURL: "https://squid-game-ortiz-default-rtdb.firebaseio.com",
            projectId: "squid-game-ortiz",
            storageBucket: "squid-game-ortiz.firebasestorage.app",
            messagingSenderId: "564790427576",
            appId: "1:564790427576:web:585ed1ec3d9dea792a594d"
        };

        // Initialize Firebase with proper waiting
        let db;
        let gameRef;
        let playersRef;
        let gameId;
        let playerId;
        let playerName;
        let gameStateRef = null;
        
        // Game state variables
        let currentRound = 1;
        let maxRounds = 3;
        let playerScores = {};
        let gameWinner = null;
        let roundResults = [];

        // Wait for Firebase to be available
        function initializeFirebase() {
            if (window.firebase && window.firebase.database) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                    console.log('‚úÖ Firebase initialized successfully');
                    
                    // Initialize game variables
                    const urlParams = new URLSearchParams(window.location.search);
                    gameId = urlParams.get('gameId');
                    playerName = localStorage.getItem('soldierName') || 'Jugador';
                    
                    // Use player name as ID to ensure visibility
                    playerId = playerName.replace(/[^a-zA-Z0-9]/g, '_');

                    // Always use the main room for chinos game
                    gameId = 'main';
                    console.log('üéÆ Using main room for chinos game:', gameId);
                    
                    // Update URL with the main game ID
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('gameId', gameId);
                    window.history.replaceState({}, '', newUrl);

                    gameRef = db.ref(`chinos/${gameId}`);
                    playersRef = db.ref(`chinos/${gameId}/players`);
                    gameStateRef = db.ref(`chinos/${gameId}/gameState`);
                    
                    console.log('üéÆ Game initialized:', { gameId, playerId, playerName });
                    
                    // Start the game
                    initializeGame();
                    
                } catch (error) {
                    console.error('‚ùå Firebase initialization error:', error);
                    setTimeout(initializeFirebase, 1000);
                }
            } else {
                console.log('‚è≥ Waiting for Firebase...');
                setTimeout(initializeFirebase, 100);
            }
        }

        // Initialize game when Firebase is ready
        function initializeGame() {
            console.log('üéÆ Starting Chinos game...');
            
            // Setup Firebase listeners
            setupFirebaseListeners();
            
            // Initialize player
            initializePlayer();
        }

        // Setup Firebase listeners
        function setupFirebaseListeners() {
            console.log('üîó Setting up Firebase listeners...');
            
            // Listener de jugadores para juego online
            playersRef.on('value', (snapshot) => {
                const players = snapshot.val();
                console.log('üë• Jugadores recibidos de Firebase:', players);
                
                if (!players) {
                    console.log('‚ö†Ô∏è No hay jugadores en Firebase');
                    updatePlayersList({});
                    return;
                }

                updatePlayersList(players);
                
                // Contar jugadores online
                const onlinePlayers = Object.values(players).filter(p => p.online);
                const previousTotal = totalPlayers;
                totalPlayers = onlinePlayers.length;
                
                console.log('üìä Estado de jugadores:', { 
                    total: Object.keys(players).length, 
                    online: totalPlayers,
                    collectedData: collectedData
                });
                
                // Log si cambi√≥ el n√∫mero de jugadores
                if (previousTotal !== totalPlayers) {
                    console.log(`üë• Cambio en jugadores: ${totalPlayers} jugadores online`);
                }
                
                // Validar l√≠mites de jugadores
                if (totalPlayers < MIN_PLAYERS) {
                    console.log('‚è≥ Esperando m√°s jugadores...');
                    showWaitingRoom();
                    stopWaitingTimer();
                    const waitingMessage = document.getElementById('waiting-message');
                    if (waitingMessage) {
                        waitingMessage.textContent = `‚è≥ Esperando jugadores... (${totalPlayers}/${MIN_PLAYERS})`;
                    }
                } else if (totalPlayers > MAX_PLAYERS) {
                    console.log('‚ö†Ô∏è Demasiados jugadores, esperando que algunos se desconecten...');
                    showWaitingRoom();
                    stopWaitingTimer();
                    const waitingMessage = document.getElementById('waiting-message');
                    if (waitingMessage) {
                        waitingMessage.textContent = `‚ö†Ô∏è Demasiados jugadores (${totalPlayers}/${MAX_PLAYERS}). Esperando que algunos se desconecten...`;
                    }
                } else {
                    // N√∫mero correcto de jugadores (entre MIN_PLAYERS y MAX_PLAYERS)
                    if (!gameStarted && !waitingTimerActive) {
                        console.log('üéÆ Jugadores suficientes, iniciando temporizador de espera...');
                        startWaitingTimer();
                    } else if (waitingTimerActive) {
                        console.log('‚è∞ Timer ya est√° activo, continuando...');
                    }
                    
                    // Revisar si tenemos todos los datos necesarios
                    checkAndCalculateResults(players);
                }
            });
        }

        // Start Firebase initialization when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Chinos page loaded, initializing Firebase...');
            initializeFirebase();
            
            // Heartbeat para mantener al jugador activo
            setInterval(() => {
                if (db && playerId) {
                    db.ref(`chinos/${gameId}/players/${playerId}/lastSeen`).set(Date.now());
                }
            }, 10000); // Actualizar cada 10 segundos
        });

        let selectedNumber = null;
        let myGuess = null;
        let countdownInterval = null;
        let playersData = {}; // Para almacenar los datos de cada jugador
        let totalPlayers = 0; // Total de jugadores en la sala
        let collectedData = 0; // Contador de datos recopilados
        let waitingTimer = null; // Timer para la sala de espera
        let waitingTimeLeft = 30; // Tiempo restante en segundos
        let gameStarted = false; // Si el juego ya comenz√≥
        let waitingTimerActive = false; // Si el timer ya est√° activo
        const MIN_PLAYERS = 2;
        const MAX_PLAYERS = 6;
        const ALLOWED_NUMBERS = [0, 1, 2, 3];
        const WAITING_TIME = 30; // Tiempo de espera en segundos

        const waitingRoom = document.getElementById('waiting-room');
        const numberSelection = document.getElementById('number-selection');
        const results = document.getElementById('results');
        const playersList = document.getElementById('players-list');
        const countdownElement = document.getElementById('countdown');
        const submitBtn = document.getElementById('submit-choice');
        const guessInput = document.getElementById('guess');

        function initializePlayer() {
            console.log('üë§ Inicializando jugador...');
            console.log('üìã Datos del jugador:', { playerId, playerName, gameId });
            
            const playerData = {
                id: playerId,
                name: playerName,
                online: true,
                selectedNumber: null,
                guess: null,
                lastSeen: Date.now()
            };

            db.ref(`chinos/${gameId}/players/${playerId}`).set(playerData)
                .then(() => {
                    console.log('‚úÖ Jugador inicializado exitosamente:', playerData);
                })
                .catch((error) => {
                    console.error('‚ùå Error al inicializar jugador:', error);
                });
        }

        function updatePlayersList(players) {
            console.log('üîÑ Actualizando lista de jugadores:', players);
            playersList.innerHTML = '';
            
            if (!players || Object.keys(players).length === 0) {
                console.log('‚ö†Ô∏è No hay jugadores en la lista');
                playersList.innerHTML = '<div class="player-card"><h3>‚è≥ Esperando jugadores...</h3><p>Nadie conectado a√∫n</p></div>';
                return;
            }
            
            // Limpiar jugadores offline (m√°s de 30 segundos sin actividad)
            const now = Date.now();
            const activePlayers = {};
            let cleanedCount = 0;
            
            Object.keys(players).forEach(playerId => {
                const player = players[playerId];
                const timeSinceLastSeen = now - (player.lastSeen || 0);
                
                // Si el jugador no ha estado activo en 30 segundos, marcarlo como offline
                if (timeSinceLastSeen > 30000) { // 30 segundos
                    console.log(`üßπ Limpiando jugador inactivo: ${player.name} (√∫ltima actividad: ${Math.round(timeSinceLastSeen/1000)}s)`);
                    db.ref(`chinos/${gameId}/players/${playerId}`).remove();
                    cleanedCount++;
                } else if (player.online) {
                    activePlayers[playerId] = player;
                }
            });
            
            if (cleanedCount > 0) {
                console.log(`üßπ Limpiados ${cleanedCount} jugadores inactivos`);
                return; // La lista se actualizar√° autom√°ticamente cuando Firebase procese los cambios
            }
            
            // Filtrar solo jugadores realmente online
            const onlinePlayers = Object.values(activePlayers).filter(player => player.online);
            console.log('üë• Jugadores realmente online:', onlinePlayers.length);
            
            onlinePlayers.forEach(player => {
                console.log('üë§ Procesando jugador online:', player);
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.ready ? 'ready' : ''}`;
                
                const playerName = player.name || 'Jugador Desconocido';
                const status = 'üü¢ Online';
                const readyStatus = (player.selectedNumber !== null && player.selectedNumber !== undefined && 
                                   player.guess !== null && player.guess !== undefined) ? '‚úÖ Listo' : '‚è≥ Esperando';
                
                playerCard.innerHTML = `
                    <h3>${playerName}</h3>
                    <p>Estado: ${status}</p>
                    <p>${readyStatus}</p>
                    ${player.selectedNumber !== null && player.selectedNumber !== undefined ? `<p>N√∫mero: ${player.selectedNumber}</p>` : ''}
                    ${player.guess !== null && player.guess !== undefined ? `<p>Predicci√≥n: ${player.guess}</p>` : ''}
                `;
                
                playersList.appendChild(playerCard);
            });
            
            console.log('‚úÖ Lista de jugadores actualizada. Total jugadores online:', onlinePlayers.length);
        }

        // Funci√≥n para iniciar el temporizador de espera
        function startWaitingTimer() {
            if (waitingTimer) {
                clearInterval(waitingTimer);
            }
            
            waitingTimeLeft = WAITING_TIME;
            gameStarted = false;
            waitingTimerActive = true;
            
            console.log('‚è∞ Iniciando temporizador de espera de', WAITING_TIME, 'segundos');
            
            waitingTimer = setInterval(() => {
                waitingTimeLeft--;
                
                const waitingMessage = document.getElementById('waiting-message');
                if (waitingMessage) {
                    waitingMessage.textContent = `‚è≥ Esperando m√°s jugadores... (${totalPlayers}/${MIN_PLAYERS}) - Iniciando en ${waitingTimeLeft}s`;
                }
                
                console.log(`‚è∞ Tiempo restante: ${waitingTimeLeft} segundos`);
                
                if (waitingTimeLeft <= 0) {
                    console.log('üéÆ ¬°Tiempo de espera terminado! Iniciando juego...');
                    stopWaitingTimer();
                    gameStarted = true;
                    showNumberSelection();
                }
            }, 1000);
        }

        // Funci√≥n para detener el temporizador de espera
        function stopWaitingTimer() {
            if (waitingTimer) {
                clearInterval(waitingTimer);
                waitingTimer = null;
                waitingTimerActive = false;
                console.log('‚è∞ Temporizador de espera detenido');
            }
        }



        function showWaitingRoom() {
            waitingRoom.style.display = 'block';
            numberSelection.style.display = 'none';
            results.style.display = 'none';
        }

        function showNumberSelection() {
            waitingRoom.style.display = 'none';
            numberSelection.style.display = 'block';
            results.style.display = 'none';
            console.log('üéÆ Pantalla de selecci√≥n de n√∫meros mostrada');
            
            // Actualizar display de puntuaciones si ya hay datos
            if (Object.keys(playerScores).length > 0) {
                updateScoreDisplay();
            }
        }

        function showResults(gameState) {
            console.log('üèÅ Mostrando resultados de la ronda:', gameState);
            
            waitingRoom.style.display = 'none';
            numberSelection.style.display = 'none';
            results.style.display = 'block';

            const resultsContent = document.getElementById('results-content');
            const totalSum = gameState.totalSum;
            const winner = gameState.winner;

            let html = `<div class="total-sum">Suma Total: ${totalSum}</div>`;
            
            // Convertir players de objeto a array si es necesario
            let playersArray = [];
            if (Array.isArray(gameState.players)) {
                playersArray = gameState.players;
            } else if (gameState.players && typeof gameState.players === 'object') {
                playersArray = Object.values(gameState.players);
            }
            
            console.log('üë• Jugadores para mostrar:', playersArray);
            
            // Mostrar resultados de cada jugador
            playersArray.forEach(player => {
                const isWinner = player.name === winner || player.id === winner;
                const status = isWinner ? 'winner' : 'loser';
                const icon = isWinner ? 'üèÜ' : 'üíÄ';
                const playerName = player.name || 'Jugador Desconocido';
                
                html += `
                    <div class="${status}">
                        ${icon} ${playerName}: Seleccion√≥ ${player.selectedNumber}, 
                        predijo ${player.guess} 
                        ${isWinner ? '(GANADOR DE LA RONDA!)' : ''}
                    </div>
                `;
            });

            // Mostrar mensaje de la ronda
            if (winner) {
                const winnerPlayer = playersArray.find(p => p.name === winner || p.id === winner);
                const winnerName = winnerPlayer ? winnerPlayer.name : winner;
                html += `<div class="winner">üéâ ¬°${winnerName} ha ganado la ronda ${currentRound}! üéâ</div>`;
            } else {
                html += `<div class="loser">üòî Nadie acert√≥ la suma total en la ronda ${currentRound}.</div>`;
            }

            // Actualizar puntuaciones
            updatePlayerScores(winner, playersArray);
            
            // Guardar resultado de la ronda
            roundResults.push({
                round: currentRound,
                totalSum: totalSum,
                winner: winner,
                players: playersArray
            });

            resultsContent.innerHTML = html;

            // Mostrar botones seg√∫n el estado del juego
            const nextRoundBtn = document.getElementById('next-round-btn');
            const finishGameBtn = document.getElementById('finish-game-btn');
            
            if (currentRound < maxRounds && !gameWinner) {
                // Mostrar bot√≥n de siguiente ronda
                nextRoundBtn.style.display = 'inline-block';
                finishGameBtn.style.display = 'none';
                
                nextRoundBtn.onclick = () => {
                    currentRound++;
                    startNextRound();
                };
            } else {
                // Juego terminado, mostrar bot√≥n de finalizar
                nextRoundBtn.style.display = 'none';
                finishGameBtn.style.display = 'inline-block';
                
                finishGameBtn.onclick = () => {
                    showFinalResults();
                };
            }

            // Asignar monedas solo al final del juego completo
            if (gameWinner) {
                const currentPlayerName = localStorage.getItem('soldierName') || playerName;
                if (gameWinner === currentPlayerName || gameWinner === playerId) {
                    addCoins(2000);
                    console.log('üèÜ ¬°Ganaste el juego completo! +2000 monedas');
                } else {
                    subtractCoins(500);
                    console.log('üíÄ Perdiste el juego completo -500 monedas');
                }
            }
        }

        function checkAndCalculateResults(players) {
            console.log('üîç Revisando datos de jugadores...');
            
            // Limpiar datos anteriores
            playersData = {};
            collectedData = 0;
            
            // Revisar cada jugador online
            Object.values(players).forEach(player => {
                console.log(`üîç Revisando jugador ${player.name}:`, {
                    online: player.online,
                    selectedNumber: player.selectedNumber,
                    guess: player.guess,
                    hasValidData: player.online && 
                                 (player.selectedNumber === 0 || player.selectedNumber) && 
                                 (player.guess === 0 || player.guess)
                });
                
                // Validaci√≥n m√°s flexible: aceptar 0 como valor v√°lido
                if (player.online && 
                    (player.selectedNumber === 0 || player.selectedNumber) && 
                    (player.guess === 0 || player.guess)) {
                    console.log(`‚úÖ Datos completos de ${player.name}: N√∫mero=${player.selectedNumber}, Predicci√≥n=${player.guess}`);
                    playersData[player.id] = {
                        id: player.id,
                        name: player.name,
                        selectedNumber: player.selectedNumber,
                        guess: player.guess
                    };
                    collectedData++;
                } else if (player.online) {
                    console.log(`‚è≥ ${player.name} a√∫n no ha enviado datos completos`);
                    if (player.selectedNumber !== 0 && !player.selectedNumber) console.log(`  - Falta n√∫mero seleccionado`);
                    if (player.guess !== 0 && !player.guess) console.log(`  - Falta predicci√≥n`);
                }
            });
            
            console.log(`üìä Datos recopilados: ${collectedData}/${totalPlayers}`);
            
            // Log de progreso
            if (collectedData > 0) {
                console.log(`üìä Progreso: ${collectedData}/${totalPlayers} jugadores han enviado datos`);
            }
            
            // Si tenemos todos los datos, calcular resultados
            if (collectedData === totalPlayers && totalPlayers >= MIN_PLAYERS && totalPlayers <= MAX_PLAYERS) {
                console.log('üéØ Todos los datos recopilados, calculando resultados...');
                calculateResults();
            }
        }

        function calculateResults() {
            console.log('üéØ Iniciando c√°lculo de resultados...');
            console.log('üë• Datos de jugadores:', playersData);
            
            if (Object.keys(playersData).length < MIN_PLAYERS) {
                console.log('‚ùå No hay suficientes datos para calcular resultados');
                return;
            }
            
            if (Object.keys(playersData).length > MAX_PLAYERS) {
                console.log('‚ùå Demasiados jugadores para el juego');
                return;
            }

            // Calcular suma total
            const totalSum = Object.values(playersData).reduce((sum, player) => sum + player.selectedNumber, 0);
            console.log('üî¢ Suma total de n√∫meros seleccionados:', totalSum);
            
            // Mostrar las elecciones de cada jugador
            Object.values(playersData).forEach(player => {
                console.log(`üë§ ${player.name}: N√∫mero=${player.selectedNumber}, Predicci√≥n=${player.guess}`);
            });
            
            // Encontrar ganador (el que predijo correctamente la suma)
            const winner = Object.values(playersData).find(player => player.guess === totalSum);
            console.log('üèÜ Ganador:', winner ? winner.name : 'Ninguno');
            
            const gameState = {
                phase: 'results',
                totalSum: totalSum,
                winner: winner ? winner.name : null,
                players: Object.values(playersData), // Convertir a array
                endTime: Date.now()
            };

            console.log('üíæ Guardando resultados en Firebase...');
            gameStateRef.set(gameState)
                .then(() => {
                    console.log('‚úÖ Resultados calculados y guardados:', gameState);
                    // Mostrar resultados inmediatamente
                    showResults(gameState);
                })
                .catch((error) => {
                    console.error('‚ùå Error al guardar resultados:', error);
                });
        }

        document.querySelectorAll('.number-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                console.log('üî¢ N√∫mero seleccionado:', btn.dataset.number);
                document.querySelectorAll('.number-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedNumber = parseInt(btn.dataset.number);
                console.log('‚úÖ N√∫mero guardado:', selectedNumber);
                checkSubmitButton();
            });
        });

        guessInput.addEventListener('input', () => {
            myGuess = parseInt(guessInput.value);
            console.log('üéØ Predicci√≥n ingresada:', myGuess);
            checkSubmitButton();
        });

        function checkSubmitButton() {
            // Validaci√≥n robusta para m√≥vil y escritorio
            let guessValue = guessInput.value;
            if (typeof guessValue === 'string') guessValue = guessValue.trim();
            const parsedGuess = parseInt(guessValue);
            const isValid = selectedNumber !== null && parsedGuess !== null && !isNaN(parsedGuess) && 
                           ALLOWED_NUMBERS.includes(selectedNumber) && parsedGuess >= 0 && parsedGuess <= 18;
            submitBtn.disabled = !isValid;
            myGuess = isValid ? parsedGuess : null;
            // Feedback visual
            const errorDiv = document.getElementById('mobile-error');
            if (selectedNumber === null) {
                errorDiv.textContent = 'Selecciona un n√∫mero (0, 1, 2 o 3).';
                errorDiv.style.display = 'block';
            } else if (!parsedGuess || isNaN(parsedGuess)) {
                errorDiv.textContent = 'Introduce una predicci√≥n v√°lida.';
                errorDiv.style.display = 'block';
            } else if (parsedGuess < 0 || parsedGuess > 18) {
                errorDiv.textContent = 'La predicci√≥n debe ser entre 0 y 18.';
                errorDiv.style.display = 'block';
            } else {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
        }

        // Evento click del bot√≥n submit
        submitBtn.addEventListener('click', () => {
            console.log('üîò Bot√≥n enviar clickeado');
            
            // Mostrar feedback visual inmediato
            submitBtn.textContent = 'Enviando...';
            submitBtn.disabled = true;
            
            const errorDiv = document.getElementById('mobile-error');
            if (selectedNumber === null || !ALLOWED_NUMBERS.includes(selectedNumber)) {
                errorDiv.textContent = 'Selecciona un n√∫mero v√°lido (0, 1, 2 o 3).';
                errorDiv.style.display = 'block';
                submitBtn.textContent = 'Confirmar';
                submitBtn.disabled = false;
                return;
            }
            if (!myGuess || isNaN(myGuess)) {
                errorDiv.textContent = 'Introduce una predicci√≥n v√°lida.';
                errorDiv.style.display = 'block';
                submitBtn.textContent = 'Confirmar';
                submitBtn.disabled = false;
                return;
            }
            if (myGuess < 0 || myGuess > 18) {
                errorDiv.textContent = 'La predicci√≥n debe ser entre 0 y 18.';
                errorDiv.style.display = 'block';
                submitBtn.textContent = 'Confirmar';
                submitBtn.disabled = false;
                return;
            }
            
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
            
            console.log('üìä Datos actuales:', { selectedNumber, myGuess, playerName, gameId, playerId });

            // Enviar datos a Firebase para juego online
            const updates = {};
            updates[`chinos/${gameId}/players/${playerId}/selectedNumber`] = selectedNumber;
            updates[`chinos/${gameId}/players/${playerId}/guess`] = myGuess;
            updates[`chinos/${gameId}/players/${playerId}/name`] = playerName;
            updates[`chinos/${gameId}/players/${playerId}/online`] = true;
            
            console.log('üì§ Datos a enviar:', updates);
            console.log('üéØ Ruta completa:', `chinos/${gameId}/players/${playerId}`);

            console.log('üî• Enviando a Firebase:', updates);
            console.log('üåê Firebase config:', firebaseConfig);
            console.log('üîó Database URL:', firebaseConfig.databaseURL);

            // Timeout de seguridad (15 segundos para m√≥vil)
            const timeoutId = setTimeout(() => {
                console.error('‚è∞ TIMEOUT alcanzado - Firebase no responde');
                submitBtn.textContent = 'Confirmar';
                submitBtn.disabled = false;
            }, 15000);

            db.ref().update(updates)
                .then(() => {
                    clearTimeout(timeoutId); // Limpiar timeout
                    console.log('‚úÖ Datos enviados exitosamente a Firebase');
                    submitBtn.textContent = 'Enviado ‚úì';
                    
                    // Mostrar mensaje de √©xito
                    errorDiv.textContent = '¬°Datos enviados! Esperando resultados...';
                    errorDiv.style.color = '#4ecdc4';
                    errorDiv.style.display = 'block';
                    
                    // Cambiar a modo de espera
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Enviado ‚úì';
                })
                .catch((error) => {
                    clearTimeout(timeoutId); // Limpiar timeout
                    console.error('‚ùå Error al enviar datos a Firebase:', error);
                    submitBtn.textContent = 'Confirmar';
                    submitBtn.disabled = false;
                    
                    if (error.code === 'PERMISSION_DENIED') {
                        errorDiv.textContent = 'Error de permisos en Firebase. Las reglas de seguridad est√°n bloqueando la escritura.';
                    } else if (error.code === 'UNAVAILABLE') {
                        errorDiv.textContent = 'Firebase no est√° disponible. Verifica tu conexi√≥n a internet.';
                    } else {
                        errorDiv.textContent = 'Error al enviar datos: ' + error.message;
                    }
                    errorDiv.style.color = '#ff6b6b';
                    errorDiv.style.display = 'block';
                });
            
            console.log('üì§ Enviando elecci√≥n:', { selectedNumber, guess: myGuess, name: playerName });
        });

        function addCoins(amount) {
            const currentCoins = parseInt(localStorage.getItem('totalOrtizCoins') || '0');
            const newCoins = currentCoins + amount;
            localStorage.setItem('totalOrtizCoins', newCoins.toString());
            
            const playerName = localStorage.getItem('soldierName');
            if (playerName && window.firebase && window.firebase.database) {
                const db = window.firebase.database();
                const playerRef = db.ref(`players/${playerName}`);
                
                playerRef.once('value')
                    .then((snapshot) => {
                        const playerData = snapshot.val() || {};
                        const firebaseCoins = parseInt(playerData.coins || '0');
                        const newFirebaseCoins = firebaseCoins + amount;
                        
                        return playerRef.update({
                            coins: newFirebaseCoins,
                            lastUpdated: Date.now()
                        });
                    })
                    .then(() => {
                        console.log(`üí∞ Monedas de Firebase actualizadas para ${playerName}: +${amount} monedas`);
                    })
                    .catch((error) => {
                        console.error(`‚ùå Error al actualizar monedas en Firebase para ${playerName}:`, error);
                    });
            }
            
            console.log(`üí∞ Monedas locales actualizadas: +${amount} monedas (Total: ${newCoins})`);
        }

        function subtractCoins(amount) {
            const currentCoins = parseInt(localStorage.getItem('totalOrtizCoins') || '0');
            const newCoins = Math.max(0, currentCoins - amount);
            localStorage.setItem('totalOrtizCoins', newCoins.toString());
            
            const playerName = localStorage.getItem('soldierName');
            if (playerName && window.firebase && window.firebase.database) {
                const db = window.firebase.database();
                const playerRef = db.ref(`players/${playerName}`);
                
                playerRef.once('value')
                    .then((snapshot) => {
                        const playerData = snapshot.val() || {};
                        const firebaseCoins = parseInt(playerData.coins || '0');
                        const newFirebaseCoins = Math.max(0, firebaseCoins - amount);
                        
                        return playerRef.update({
                            coins: newFirebaseCoins,
                            lastUpdated: Date.now()
                        });
                    })
                    .then(() => {
                        console.log(`üí∞ Monedas de Firebase actualizadas para ${playerName}: -${amount} monedas`);
                    })
                    .catch((error) => {
                        console.error(`‚ùå Error al actualizar monedas en Firebase para ${playerName}:`, error);
                    });
            }
            
            console.log(`üí∞ Monedas locales actualizadas: -${amount} monedas (Total: ${newCoins})`);
        }

        window.addEventListener('beforeunload', () => {
            if (db && playerId) {
                console.log('üëã Jugador saliendo, limpiando datos...');
                db.ref(`chinos/${gameId}/players/${playerId}`).remove();
            }
        });

        // Tambi√©n limpiar cuando se cierra la pesta√±a o se navega
        window.addEventListener('pagehide', () => {
            if (db && playerId) {
                console.log('üëã P√°gina cerrada, limpiando datos...');
                db.ref(`chinos/${gameId}/players/${playerId}`).remove();
            }
        });

        // Funci√≥n para probar conectividad con Firebase
        function testFirebaseConnection() {
            console.log('üîç Probando conectividad con Firebase...');
            db.ref('test-connection').set({ timestamp: Date.now(), test: true })
                .then(() => {
                    console.log('‚úÖ Conexi√≥n con Firebase OK');
                })
                .catch((error) => {
                    console.error(`‚ùå Error de conectividad: ${error.code} - ${error.message}`);
                });
        }

        // Funciones para el sistema de rondas
        function updatePlayerScores(winner, playersArray) {
            console.log('üìä Actualizando puntuaciones...');
            
            // Inicializar puntuaciones si no existen
            if (Object.keys(playerScores).length === 0) {
                playersArray.forEach(player => {
                    playerScores[player.name] = 0;
                });
            }
            
            // Sumar punto al ganador de la ronda
            if (winner) {
                playerScores[winner] = (playerScores[winner] || 0) + 1;
                console.log(`üèÜ ${winner} gana 1 punto. Total: ${playerScores[winner]}`);
            }
            
            // Verificar si hay un ganador del juego (3 puntos)
            Object.keys(playerScores).forEach(playerName => {
                if (playerScores[playerName] >= 3) {
                    gameWinner = playerName;
                    console.log(`üéâ ¬°${playerName} ha ganado el juego completo con ${playerScores[playerName]} puntos!`);
                }
            });
            
            // Actualizar display de puntuaciones
            updateScoreDisplay();
        }
        
        function updateScoreDisplay() {
            const playersScoreDiv = document.getElementById('players-score');
            const currentRoundSpan = document.getElementById('current-round');
            
            if (playersScoreDiv) {
                let scoreHtml = '';
                Object.keys(playerScores).forEach(playerName => {
                    const score = playerScores[playerName] || 0;
                    const isCurrentPlayer = playerName === localStorage.getItem('soldierName');
                    const playerClass = isCurrentPlayer ? 'current-player' : '';
                    scoreHtml += `
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; border: 2px solid ${isCurrentPlayer ? '#4ecdc4' : '#ff6b6b'};">
                            <div style="font-weight: bold; color: ${isCurrentPlayer ? '#4ecdc4' : '#ff6b6b'};">
                                ${playerName} ${isCurrentPlayer ? '(T√∫)' : ''}
                            </div>
                            <div style="font-size: 1.5em; color: #ffd93d;">
                                ${score} ${score === 1 ? 'punto' : 'puntos'}
                            </div>
                        </div>
                    `;
                });
                playersScoreDiv.innerHTML = scoreHtml;
            }
            
            if (currentRoundSpan) {
                currentRoundSpan.textContent = `Ronda ${currentRound}`;
            }
        }
        
        function startNextRound() {
            console.log(`üîÑ Iniciando ronda ${currentRound}...`);
            
            // Limpiar datos de la ronda anterior
            selectedNumber = null;
            myGuess = null;
            playersData = {};
            collectedData = 0;
            
            // Limpiar selecciones de botones
            document.querySelectorAll('.number-btn').forEach(b => b.classList.remove('selected'));
            
            // Limpiar input
            const guessInput = document.getElementById('guess');
            if (guessInput) guessInput.value = '';
            
            // Resetear bot√≥n submit
            const submitBtn = document.getElementById('submit-choice');
            if (submitBtn) {
                submitBtn.textContent = 'Confirmar';
                submitBtn.disabled = true;
            }
            
            // Limpiar mensajes de error
            const errorDiv = document.getElementById('mobile-error');
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
            
            // Limpiar datos de Firebase para la nueva ronda
            if (db && gameId) {
                const updates = {};
                Object.keys(playerScores).forEach(playerName => {
                    const playerId = playerName.replace(/[^a-zA-Z0-9]/g, '_');
                    updates[`chinos/${gameId}/players/${playerId}/selectedNumber`] = null;
                    updates[`chinos/${gameId}/players/${playerId}/guess`] = null;
                });
                
                db.ref().update(updates).then(() => {
                    console.log('‚úÖ Datos de Firebase limpiados para nueva ronda');
                }).catch((error) => {
                    console.error('‚ùå Error limpiando datos de Firebase:', error);
                });
            }
            
            // Mostrar pantalla de selecci√≥n
            showNumberSelection();
            
            // Actualizar display de puntuaciones
            updateScoreDisplay();
        }
        
        function showFinalResults() {
            console.log('üèÅ Mostrando resultados finales del juego');
            
            waitingRoom.style.display = 'none';
            numberSelection.style.display = 'none';
            results.style.display = 'block';
            
            const resultsContent = document.getElementById('results-content');
            const nextRoundBtn = document.getElementById('next-round-btn');
            const finishGameBtn = document.getElementById('finish-game-btn');
            
            // Ocultar botones de ronda
            nextRoundBtn.style.display = 'none';
            finishGameBtn.style.display = 'none';
            
            let html = `<div class="total-sum">üèÜ RESULTADOS FINALES</div>`;
            
            // Mostrar puntuaciones finales
            const sortedPlayers = Object.keys(playerScores).sort((a, b) => playerScores[b] - playerScores[a]);
            
            sortedPlayers.forEach((playerName, index) => {
                const score = playerScores[playerName];
                const isWinner = playerName === gameWinner;
                const isCurrentPlayer = playerName === localStorage.getItem('soldierName');
                const icon = isWinner ? 'üëë' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üíÄ';
                const color = isWinner ? '#ffd93d' : isCurrentPlayer ? '#4ecdc4' : '#ff6b6b';
                
                html += `
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0; border: 2px solid ${color};">
                        <div style="font-size: 1.5em; color: ${color}; font-weight: bold;">
                            ${icon} ${playerName} ${isCurrentPlayer ? '(T√∫)' : ''}
                        </div>
                        <div style="font-size: 1.2em; color: #fff;">
                            ${score} ${score === 1 ? 'punto' : 'puntos'}
                        </div>
                        ${isWinner ? '<div style="color: #ffd93d; font-weight: bold; margin-top: 5px;">¬°GANADOR DEL JUEGO!</div>' : ''}
                    </div>
                `;
            });
            
            // Agregar bot√≥n de volver al men√∫
            html += `
                <div style="margin-top: 30px; text-align: center;">
                    <button class="back-btn" onclick="window.location.href='index.html'">
                        üè† Volver al Men√∫ Principal
                    </button>
                </div>
            `;
            
            resultsContent.innerHTML = html;
        }

        // Inicializar jugador y estado del juego
        initializePlayer();
        
        // Inicializar estado del juego si no existe
        gameStateRef.on('value', (snapshot) => {
            const gameState = snapshot.val();
            console.log('üéÆ Estado del juego recibido:', gameState);
            
            if (!gameState) {
                console.log('üÜï Inicializando estado del juego Chinos');
                gameStateRef.set({
                    phase: 'waiting',
                    countdown: 10,
                    startTime: null
                });
            } else if (gameState.phase === 'results') {
                console.log('üèÅ Mostrando resultados del juego');
                showResults(gameState);
            } else if (gameState.phase === 'playing') {
                console.log('üéÆ Juego en progreso, mostrando pantalla de selecci√≥n');
                showNumberSelection();
            }
        });
    </script>
</body>
</html> 