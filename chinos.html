<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinos - Squid Game</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .chinos-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .number-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .number-btn {
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .number-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        .number-btn.selected {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border-color: #4ecdc4;
        }
        .guess-input {
            margin: 20px 0;
        }
        .guess-input input {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            text-align: center;
            width: 100px;
        }
        .submit-btn {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .players-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .player-card {
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #ff6b6b;
        }
        .player-card.ready {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
        .countdown {
            font-size: 48px;
            font-weight: bold;
            color: #ff6b6b;
            margin: 20px 0;
        }
        .results {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        .winner {
            color: #4ecdc4;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .loser {
            color: #ff6b6b;
            font-size: 18px;
            margin: 5px 0;
        }
        .total-sum {
            font-size: 36px;
            font-weight: bold;
            color: #ffd93d;
            margin: 15px 0;
        }
        .back-btn {
            margin-top: 20px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
    </style>
</head>
<body>
    <div class="chinos-container">
        <h1>üé≤ Chinos</h1>
        <p>Selecciona un n√∫mero y adivina la suma total</p>

        <div id="waiting-room" class="game-phase">
            <h2>Sala de Espera</h2>
            <div id="players-list" class="players-status"></div>
            <div id="countdown" class="countdown"></div>
        </div>

        <div id="number-selection" class="game-phase" style="display: none;">
            <h2>Selecciona tu n√∫mero</h2>
            <div class="number-buttons">
                <button class="number-btn" data-number="1">1</button>
                <button class="number-btn" data-number="2">2</button>
                <button class="number-btn" data-number="3">3</button>
                <button class="number-btn" data-number="4">4</button>
            </div>
            <div class="guess-input">
                <label for="guess">Tu predicci√≥n de la suma total:</label><br>
                <input type="number" id="guess" min="2" max="16" placeholder="Ej: 5">
            </div>
            <button id="submit-choice" class="submit-btn" disabled>Confirmar</button>
        </div>

        <div id="results" class="game-phase" style="display: none;">
            <h2>Resultados</h2>
            <div id="results-content"></div>
            <button class="back-btn" onclick="window.location.href='index.html'">Volver al Men√∫</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBxGUOlJvH1_8j0qXqXqXqXqXqXqXqXqXqX",
            authDomain: "squid-game-ortiz.firebaseapp.com",
            databaseURL: "https://squid-game-ortiz-default-rtdb.firebaseio.com",
            projectId: "squid-game-ortiz",
            storageBucket: "squid-game-ortiz.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnop"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('gameId');
        const playerId = urlParams.get('playerId') || 'player_' + Date.now();
        const playerName = localStorage.getItem('playerName') || 'Jugador';

        if (!gameId) {
            alert('Error: No se encontr√≥ el ID del juego');
            window.location.href = 'index.html';
        }

        const gameRef = ref(db, `chinos/${gameId}`);
        const playersRef = ref(db, `chinos/${gameId}/players`);
        const gameStateRef = ref(db, `chinos/${gameId}/gameState`);

        // Variables para manejar la creaci√≥n autom√°tica de salas
        let roomCreationAttempts = 0;
        const maxRoomCreationAttempts = 3;
        let roomCreationTimeout = null;

        let selectedNumber = null;
        let myGuess = null;
        let countdownInterval = null;

        const waitingRoom = document.getElementById('waiting-room');
        const numberSelection = document.getElementById('number-selection');
        const results = document.getElementById('results');
        const playersList = document.getElementById('players-list');
        const countdownElement = document.getElementById('countdown');
        const submitBtn = document.getElementById('submit-choice');
        const guessInput = document.getElementById('guess');

        function initializePlayer() {
            const playerData = {
                id: playerId,
                name: playerName,
                online: true,
                ready: false,
                selectedNumber: null,
                guess: null
            };

            set(ref(db, `chinos/${gameId}/players/${playerId}`), playerData);
            console.log('Jugador inicializado:', playerData);
        }

        onValue(gameStateRef, (snapshot) => {
            const gameState = snapshot.val();
            if (!gameState) {
                // Si no existe el estado del juego, intentar crear la sala autom√°ticamente
                if (roomCreationAttempts < maxRoomCreationAttempts) {
                    roomCreationAttempts++;
                    console.log(`üîÑ Intento ${roomCreationAttempts}/${maxRoomCreationAttempts}: Creando sala de juego Chinos autom√°ticamente`);
                    
                    if (roomCreationTimeout) {
                        clearTimeout(roomCreationTimeout);
                    }
                    
                    roomCreationTimeout = setTimeout(() => {
                        createGameRoom();
                    }, 1000 * roomCreationAttempts);
                } else {
                    console.log('‚ùå No se pudo crear la sala de juego despu√©s de varios intentos');
                    alert('Error: No se pudo conectar a la sala de juego. Intenta de nuevo.');
                    window.location.href = 'index.html';
                }
                return;
            }

            console.log('Estado del juego actualizado:', gameState);

            switch (gameState.phase) {
                case 'waiting':
                    showWaitingRoom();
                    startCountdown(gameState.countdown);
                    break;
                case 'playing':
                    showNumberSelection();
                    break;
                case 'results':
                    showResults(gameState);
                    break;
            }
        });

        onValue(playersRef, (snapshot) => {
            const players = snapshot.val();
            if (!players) return;

            updatePlayersList(players);
            checkGameStart(players);
        });

        function showWaitingRoom() {
            waitingRoom.style.display = 'block';
            numberSelection.style.display = 'none';
            results.style.display = 'none';
        }

        function showNumberSelection() {
            waitingRoom.style.display = 'none';
            numberSelection.style.display = 'block';
            results.style.display = 'none';
        }

        function showResults(gameState) {
            waitingRoom.style.display = 'none';
            numberSelection.style.display = 'none';
            results.style.display = 'block';

            const resultsContent = document.getElementById('results-content');
            const totalSum = gameState.totalSum;
            const winner = gameState.winner;

            let html = `<div class="total-sum">Suma Total: ${totalSum}</div>`;
            
            Object.values(gameState.players).forEach(player => {
                const isWinner = player.id === winner;
                const status = isWinner ? 'winner' : 'loser';
                const icon = isWinner ? 'üèÜ' : 'üíÄ';
                
                html += `
                    <div class="${status}">
                        ${icon} ${player.name}: Seleccion√≥ ${player.selectedNumber}, 
                        predijo ${player.guess} 
                        ${isWinner ? '(GANADOR!)' : ''}
                    </div>
                `;
            });

            resultsContent.innerHTML = html;

            if (winner === playerId) {
                addCoins(1000);
                console.log('¬°Ganaste! +1000 monedas');
            } else {
                subtractCoins(500);
                console.log('Perdiste -500 monedas');
            }
        }

        function updatePlayersList(players) {
            playersList.innerHTML = '';
            
            Object.values(players).forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.ready ? 'ready' : ''}`;
                
                playerCard.innerHTML = `
                    <h3>${player.name}</h3>
                    <p>Estado: ${player.online ? 'üü¢ Online' : 'üî¥ Offline'}</p>
                    <p>Listo: ${player.ready ? '‚úÖ' : '‚è≥'}</p>
                `;
                
                playersList.appendChild(playerCard);
            });
        }

        function checkGameStart(players) {
            const onlinePlayers = Object.values(players).filter(p => p.online);
            const readyPlayers = onlinePlayers.filter(p => p.ready);

            if (onlinePlayers.length >= 2 && readyPlayers.length === onlinePlayers.length) {
                if (!countdownInterval) {
                    startGameCountdown();
                }
            }
        }

        function startCountdown(initialCountdown) {
            let countdown = initialCountdown || 30;
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    startGame();
                }
                
                countdown--;
            }, 1000);
        }

        function startGameCountdown() {
            let countdown = 30;
            
            countdownInterval = setInterval(() => {
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    startGame();
                }
                
                countdown--;
            }, 1000);
        }

        function startGame() {
            set(gameStateRef, {
                phase: 'playing',
                startTime: Date.now()
            });
            
            // Verificar resultados despu√©s de 60 segundos
            setTimeout(() => {
                calculateResults();
            }, 60000);
        }

        function calculateResults() {
            onValue(playersRef, (snapshot) => {
                const players = snapshot.val();
                if (!players) return;

                const onlinePlayers = Object.values(players).filter(p => p.online && p.ready);
                if (onlinePlayers.length < 2) return;

                // Calcular suma total
                const totalSum = onlinePlayers.reduce((sum, player) => sum + player.selectedNumber, 0);
                
                // Encontrar ganador (el que predijo correctamente la suma)
                const winner = onlinePlayers.find(player => player.guess === totalSum);
                
                const gameState = {
                    phase: 'results',
                    totalSum: totalSum,
                    winner: winner ? winner.id : null,
                    players: players,
                    endTime: Date.now()
                };

                set(gameStateRef, gameState);
                console.log('Resultados calculados:', gameState);
            }, { onlyOnce: true });
        }

        document.querySelectorAll('.number-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.number-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedNumber = parseInt(btn.dataset.number);
                checkSubmitButton();
            });
        });

        guessInput.addEventListener('input', () => {
            myGuess = parseInt(guessInput.value);
            checkSubmitButton();
        });

        function checkSubmitButton() {
            submitBtn.disabled = !selectedNumber || !myGuess || myGuess < 2 || myGuess > 16;
        }

        submitBtn.addEventListener('click', () => {
            if (!selectedNumber || !myGuess) return;

            const playerData = {
                selectedNumber: selectedNumber,
                guess: myGuess,
                ready: true
            };

            set(ref(db, `chinos/${gameId}/players/${playerId}`), playerData);
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviado ‚úì';
            
            console.log('Elecci√≥n enviada:', playerData);
        });

        function addCoins(amount) {
            const currentCoins = parseInt(localStorage.getItem('coins') || '0');
            const newCoins = currentCoins + amount;
            localStorage.setItem('coins', newCoins.toString());
            
            const userId = localStorage.getItem('userId');
            if (userId) {
                set(ref(db, `users/${userId}/coins`), newCoins);
            }
        }

        function subtractCoins(amount) {
            const currentCoins = parseInt(localStorage.getItem('coins') || '0');
            const newCoins = Math.max(0, currentCoins - amount);
            localStorage.setItem('coins', newCoins.toString());
            
            const userId = localStorage.getItem('userId');
            if (userId) {
                set(ref(db, `users/${userId}/coins`), newCoins);
            }
        }

        function createGameRoom() {
            console.log('üèóÔ∏è Creando sala de juego Chinos autom√°ticamente');
            
            // Crear el estado inicial del juego
            set(gameStateRef, {
                phase: 'waiting',
                countdown: 30,
                startTime: null,
                autoCreated: true
            });
            
            // Crear la sala de juego en gameRooms
            const gameRoomRef = ref(db, `gameRooms/${gameId}`);
            set(gameRoomRef, {
                gameId: gameId,
                status: 'waiting',
                createdAt: Date.now(),
                autoCreated: true,
                game: 'chinos'
            });
            
            console.log('‚úÖ Sala de juego Chinos creada autom√°ticamente');
        }

        window.addEventListener('beforeunload', () => {
            remove(ref(db, `chinos/${gameId}/players/${playerId}`));
        });

        initializePlayer();
        
        // Inicializar estado del juego si no existe
        onValue(gameStateRef, (snapshot) => {
            const gameState = snapshot.val();
            if (!gameState) {
                console.log('üÜï Inicializando estado del juego Chinos');
                set(gameStateRef, {
                    phase: 'waiting',
                    countdown: 30,
                    startTime: null
                });
            }
        }, { onlyOnce: true });
        
        // Crear sala de juego autom√°ticamente si no existe
        const gameRoomRef = ref(db, `gameRooms/${gameId}`);
        onValue(gameRoomRef, (snapshot) => {
            const gameRoom = snapshot.val();
            if (!gameRoom) {
                console.log('üÜï Creando sala de juego Chinos autom√°ticamente');
                set(gameRoomRef, {
                    gameId: gameId,
                    status: 'waiting',
                    createdAt: Date.now(),
                    autoCreated: true,
                    game: 'chinos'
                });
            }
        }, { onlyOnce: true });
    </script>
</body>
</html> 