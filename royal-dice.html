<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✂️ Piedra Papel Tijera PvP - Squid Game Ortiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #FFD700;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            text-shadow: 0 0 20px #FFD700;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .header p {
            font-size: 1.2rem;
            color: #FFD700;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .player-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700;
        }

        .player-coins {
            font-size: 1.3rem;
            color: #FFD700;
        }

        .back-button {
            background: #1a1a2e;
            color: #FFD700;
            border: 2px solid #FFD700;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: #FFD700;
            color: #1a1a2e;
            box-shadow: 0 0 20px #FFD700;
        }

        .game-section {
            background: rgba(255, 215, 0, 0.08);
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #FFD700;
        }

        .tab-btn {
            background: transparent;
            color: #FFD700;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            border-bottom-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        .tab-btn:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-players {
            font-weight: bold;
            color: #FFD700;
        }

        .history-result {
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .history-result.win {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .history-result.loss {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .history-result.tie {
            background: rgba(255, 193, 7, 0.3);
            color: #FFC107;
        }

        .history-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #ccc;
        }

        .history-choices {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .choice-display {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .choice-emoji {
            font-size: 1.2rem;
        }

        .players-list {
            max-height: 400px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .player-item {
            display: flex;
            flex-direction: column;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            border-radius: 8px;
            transition: all 0.3s;
            min-height: 120px;
            justify-content: space-between;
        }

        .player-item:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .player-details {
            flex: 1;
            margin-bottom: 15px;
        }

        .player-name-display {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #FFD700;
        }

        .player-coins-display {
            font-size: 0.9rem;
            color: #FFD700;
            font-weight: bold;
        }

        .player-stats {
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 5px;
        }

        .player-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .bet-input {
            padding: 8px;
            border: 1px solid #FFD700;
            border-radius: 4px;
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            font-size: 0.9rem;
        }

        .bet-input::placeholder {
            color: rgba(255, 215, 0, 0.6);
        }

        .challenge-btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #1a1a2e;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9rem;
            width: 100%;
        }

        .challenge-btn:hover {
            background: linear-gradient(45deg, #FFA500, #FF8C00);
            transform: scale(1.05);
        }

        .challenge-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #FFD700;
            font-size: 1.1rem;
        }

        /* Game Modal Styles */
        .game-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .game-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .game-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #FFD700;
        }

        .game-title {
            font-size: 1.8rem;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .game-info {
            font-size: 1.1rem;
            color: #ccc;
        }

        .rps-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .rps-option {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .rps-option:hover {
            transform: translateY(-5px) scale(1.1);
            border-color: #FFD700;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
        }

        .rps-option.selected {
            border-color: #FFD700;
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            transform: scale(1.05);
        }

        .rps-option:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .game-status {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            font-size: 1.1rem;
            color: #FFD700;
        }

        .results {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            display: none;
        }

        .winner {
            text-align: center;
            font-size: 1.5em;
            color: #FFD700;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
        }

        .score-card {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
        }

        .score-card.winner {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        .score-card.loser {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }

        .score-card.tie {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid #FFC107;
        }

        .player-choice {
            font-size: 2rem;
            margin: 10px 0;
        }

        .player-status {
            font-size: 0.9rem;
            color: #ccc;
        }

        /* Challenge Modal */
        .challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .challenge-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .challenge-message {
            font-size: 1.3rem;
            color: #FFD700;
            margin-bottom: 15px;
        }

        .challenge-bet {
            font-size: 1.1rem;
            color: #ccc;
            margin-bottom: 25px;
        }

        .challenge-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: #FFD700;
            border-radius: 50%;
            animation: float 6s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    
    <div class="container">
        <div class="header">
            <h1>✂️ PIEDRA PAPEL TIJERA PvP</h1>
            <p>Reta a otros jugadores en batallas épicas</p>
        </div>

        <div class="player-info">
            <div class="player-name" id="currentPlayerName">Cargando...</div>
            <div class="player-coins" id="currentPlayerCoins">0 monedas</div>
            <button class="back-button" onclick="window.location.href='index.html'">← Volver</button>
        </div>

        <div class="game-section">
            <div class="section-tabs">
                <button class="tab-btn active" onclick="showTab('players')">🎯 Jugadores</button>
                <button class="tab-btn" onclick="showTab('history')">📜 Historial</button>
            </div>
            
            <div class="tab-content active" id="playersTab">
                <h2>🎯 Jugadores Disponibles</h2>
                <div class="players-list" id="playersList">
                    <div class="loading">Cargando jugadores...</div>
                </div>
            </div>
            
            <div class="tab-content" id="historyTab">
                <h2>📜 Historial de Partidas</h2>
                <div class="history-list" id="historyList">
                    <div class="loading">Cargando historial...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Challenge Modal -->
    <div class="challenge-modal" id="challengeModal">
        <div class="challenge-content">
            <div class="challenge-message" id="challengeMessage"></div>
            <div class="challenge-bet" id="challengeBetAmount"></div>
            <div class="challenge-actions">
                <button class="btn btn-primary" onclick="acceptChallenge()">✅ ACEPTAR</button>
                <button class="btn btn-danger" onclick="rejectChallenge()">❌ RECHAZAR</button>
            </div>
        </div>
    </div>

    <!-- Game Modal -->
    <div class="game-modal" id="gameModal">
        <div class="game-content">
            <div class="game-header">
                <div class="game-title">⚔️ BATALLA EN CURSO</div>
                <div class="game-info">
                    <div id="challengerName"></div>
                    <div>VS</div>
                    <div id="challengedName"></div>
                    <div>Apuesta: <span id="challengeBet"></span> monedas</div>
                </div>
            </div>

            <div class="game-status" id="gameStatus">
                Selecciona tu opción:
            </div>

            <div class="rps-options">
                <div class="rps-option" data-choice="piedra" onclick="selectChoice('piedra')">🪨</div>
                <div class="rps-option" data-choice="papel" onclick="selectChoice('papel')">📄</div>
                <div class="rps-option" data-choice="tijera" onclick="selectChoice('tijera')">✂️</div>
            </div>

            <div class="game-controls">
                <button class="btn btn-primary" id="confirmBtn" onclick="confirmChoice()" style="display: none;">CONFIRMAR</button>
                <button class="btn btn-secondary" onclick="closeGame()">CANCELAR</button>
            </div>

            <div class="game-status" id="waitingMessage" style="display: none;">
                ⏳ Esperando que el oponente elija...
            </div>

            <div class="game-status" id="choiceMade" style="display: none;">
                ✅ ¡Elección confirmada! Esperando resultado...
            </div>

            <div class="results" id="results">
                <div class="winner" id="winnerText"></div>
                <div class="score-board" id="scoreBoard"></div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBqXqXqXqXqXqXqXqXqXqXqXqXqXqXqXqX",
            authDomain: "squid-game-ortiz.firebaseapp.com",
            databaseURL: "https://squid-game-ortiz-default-rtdb.firebaseio.com",
            projectId: "squid-game-ortiz",
            storageBucket: "squid-game-ortiz.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnop"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Game variables
        let currentPlayer = '';
        let currentCoins = 0;
        let players = [];
        let currentChallenge = null;
        let myChoice = null;
        let gameState = 'lobby';

        // Create particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 20;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.width = Math.random() * 4 + 2 + 'px';
                particle.style.height = particle.style.width;
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize the page - EXACTLY like robbery game
        document.addEventListener('DOMContentLoaded', function() {
            loadPlayerInfo();
            createParticles();
            loadPlayers();
            loadHistory();
            listenForChallenges();
            listenForResults();
            startAutoSync();
        });

        // Show tab content
        window.showTab = function(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Refresh data based on tab
            switch(tabName) {
                case 'players':
                    loadPlayers();
                    break;
                case 'history':
                    loadHistory();
                    break;
            }
        };

        // Auto-sync player data with Firebase every 30 seconds - same as robbery game
        function startAutoSync() {
            setInterval(() => {
                if (window.firebase && window.firebase.database) {
                    syncPlayerDataToFirebase();
                    loadPlayers(); // Refresh player list
                }
            }, 30000); // Sync every 30 seconds
        }

        // Sync current player data to Firebase - EXACTLY like robbery game
        function syncPlayerDataToFirebase() {
            const playerName = localStorage.getItem('soldierName');
            if (!playerName || !window.firebase || !window.firebase.database) {
                return;
            }

            const db = window.firebase.database();
            const playerRef = db.ref(`players/${playerName}`);
            
            // Get current data from localStorage
            const currentCoins = parseInt(localStorage.getItem('totalOrtizCoins') || '0');
            const rpsWins = parseInt(localStorage.getItem('rpsWins') || '0');
            const rpsLosses = parseInt(localStorage.getItem('rpsLosses') || '0');
            
            const playerData = {
                name: playerName,
                coins: currentCoins,
                rpsWins: rpsWins,
                rpsLosses: rpsLosses,
                lastUpdated: Date.now(),
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    timestamp: new Date().toISOString()
                }
            };
            
            playerRef.update(playerData)
                .then(() => {
                    console.log(`✅ Player data synced to Firebase: ${playerName}`);
                })
                .catch((error) => {
                    console.error('❌ Error syncing to Firebase:', error);
                });
        }

        // Enhanced loadPlayerInfo with better Firebase sync and immediate synchronization
        function loadPlayerInfo() {
            currentPlayer = localStorage.getItem('soldierName') || 'Jugador';
            
            // Use localStorage as primary source to avoid overwriting recent changes
            const localCoins = parseInt(localStorage.getItem('totalOrtizCoins') || '0');
            currentCoins = localCoins;
            
            // Update display immediately with local data
            document.getElementById('currentPlayerName').textContent = currentPlayer;
            document.getElementById('currentPlayerCoins').textContent = currentCoins.toLocaleString() + ' monedas';
            
            console.log(`✅ Player info loaded from localStorage: ${currentPlayer} - ${currentCoins} coins`);
            
            // Only sync with Firebase if there's a significant difference (more than 1000 coins)
            if (window.firebase && window.firebase.database) {
                const db = window.firebase.database();
                const playerRef = db.ref(`players/${currentPlayer}`);
                
                playerRef.once('value')
                    .then((snapshot) => {
                        const playerData = snapshot.val() || {};
                        const firebaseCoins = playerData.coins || 0;
                        
                        // Only sync if difference is significant (more than 1000 coins)
                        if (Math.abs(firebaseCoins - localCoins) > 1000) {
                            localStorage.setItem('totalOrtizCoins', firebaseCoins.toString());
                            currentCoins = firebaseCoins;
                            document.getElementById('currentPlayerCoins').textContent = currentCoins.toLocaleString() + ' monedas';
                            console.log(`🔄 Synced coins from Firebase: ${localCoins} -> ${firebaseCoins}`);
                        }
                        
                        // Also sync other data if available
                        if (playerData.rpsWins !== undefined) {
                            localStorage.setItem('rpsWins', playerData.rpsWins.toString());
                        }
                        if (playerData.rpsLosses !== undefined) {
                            localStorage.setItem('rpsLosses', playerData.rpsLosses.toString());
                        }
                        
                        console.log(`✅ Player info synced from Firebase: ${currentPlayer} - ${currentCoins} coins`);
                    })
                    .catch((error) => {
                        console.error('❌ Error loading player info from Firebase:', error);
                    });
            }
        }

        // Load history from Firebase
        function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="loading">Cargando historial...</div>';

            if (window.firebase && window.firebase.database) {
                const db = window.firebase.database();
                const historyRef = db.ref('rpsHistory');
                
                historyRef.orderByChild('timestamp').limitToLast(20).once('value')
                    .then((snapshot) => {
                        let html = '';
                        const history = [];
                        
                        snapshot.forEach((childSnapshot) => {
                            const game = childSnapshot.val();
                            if (game && (game.challenger === currentPlayer || game.challenged === currentPlayer)) {
                                history.push(game);
                            }
                        });
                        
                        // Sort by timestamp (newest first)
                        history.sort((a, b) => b.timestamp - a.timestamp);
                        
                        if (history.length === 0) {
                            html = '<div class="loading">No hay partidas en tu historial</div>';
                        } else {
                            history.forEach((game) => {
                                const isChallenger = game.challenger === currentPlayer;
                                const opponent = isChallenger ? game.challenged : game.challenger;
                                const myChoice = isChallenger ? game.challengerChoice : game.challengedChoice;
                                const opponentChoice = isChallenger ? game.challengedChoice : game.challengerChoice;
                                
                                let resultClass = '';
                                let resultText = '';
                                
                                if (game.winner === 'tie') {
                                    resultClass = 'tie';
                                    resultText = 'EMPATE';
                                } else if ((game.winner === 'challenger' && isChallenger) || 
                                         (game.winner === 'challenged' && !isChallenger)) {
                                    resultClass = 'win';
                                    resultText = 'VICTORIA';
                                } else {
                                    resultClass = 'loss';
                                    resultText = 'DERROTA';
                                }
                                
                                const date = new Date(game.timestamp);
                                const timeString = date.toLocaleString('es-ES', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                html += `
                                    <div class="history-item">
                                        <div class="history-header">
                                            <div class="history-players">TÚ vs ${opponent}</div>
                                            <div class="history-result ${resultClass}">${resultText}</div>
                                        </div>
                                        <div class="history-details">
                                            <div class="history-choices">
                                                <div class="choice-display">
                                                    <span class="choice-emoji">${getChoiceEmoji(myChoice)}</span>
                                                    <span>TÚ: ${myChoice.toUpperCase()}</span>
                                                </div>
                                                <span>VS</span>
                                                <div class="choice-display">
                                                    <span class="choice-emoji">${getChoiceEmoji(opponentChoice)}</span>
                                                    <span>${opponent}: ${opponentChoice.toUpperCase()}</span>
                                                </div>
                                            </div>
                                            <div>
                                                <div>💰 ${game.betAmount.toLocaleString()} monedas</div>
                                                <div style="font-size: 0.8rem; color: #999;">${timeString}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        
                        historyList.innerHTML = html;
                    })
                    .catch((error) => {
                        console.error('Error loading history:', error);
                        historyList.innerHTML = '<div class="loading">Error cargando historial</div>';
                    });
            } else {
                historyList.innerHTML = '<div class="loading">Firebase no disponible</div>';
            }
        }

        // Load players from Firebase - COPIED EXACTLY from robbery game
        function loadPlayers() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '<div class="loading">Cargando jugadores...</div>';

            if (window.firebase && window.firebase.database) {
                const db = window.firebase.database();
                const playersRef = db.ref('players');
                
                playersRef.once('value')
                    .then((snapshot) => {
                        players = [];
                        let html = '';
                        
                        snapshot.forEach((childSnapshot) => {
                            const player = childSnapshot.val();
                            
                            // Validate player data - only show players with valid names
                            if (player && player.name && player.name !== 'undefined' && player.name !== currentPlayer) {
                                // Ocultar jugadores de prueba
                                const testPlayers = ['yo', 'prueba', 'prueba 2'];
                                if (!testPlayers.includes(player.name.toLowerCase())) {
                                    players.push(player);
                                    const maxBet = Math.min(player.coins || 0, currentCoins, 10000);
                                    html += `
                                        <div class="player-item">
                                            <div class="player-details">
                                                <div class="player-name-display">${player.name}</div>
                                                <div class="player-coins-display">${player.coins ? player.coins.toLocaleString() : 0} monedas</div>
                                                <div class="player-stats">🏆 ${player.rpsWins || 0}W - ${player.rpsLosses || 0}L</div>
                                            </div>
                                            <div class="player-controls">
                                                <input type="number" class="bet-input" placeholder="Cantidad a apostar" min="100" max="${maxBet}" value="100">
                                                <button class="challenge-btn" onclick="challengePlayer('${player.name}', this.previousElementSibling.value)">
                                                    ⚔️ RETAR
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                        });
                        
                        if (html === '') {
                            html = '<div class="loading">No hay otros jugadores disponibles</div>';
                        }
                        
                        playersList.innerHTML = html;
                        console.log(`✅ Loaded ${players.length} valid players from Firebase`);
                    })
                    .catch((error) => {
                        console.error('Error loading players:', error);
                        playersList.innerHTML = '<div class="loading">Error cargando jugadores</div>';
                    });
            } else {
                playersList.innerHTML = '<div class="loading">Firebase no disponible</div>';
            }
        }

        // Challenge a player
        window.challengePlayer = function(playerName, betAmount) {
            betAmount = parseInt(betAmount);
            
            if (!betAmount || betAmount < 100) {
                alert('La apuesta mínima es 100 monedas');
                return;
            }
            
            if (betAmount > currentCoins) {
                alert(`No tienes suficientes monedas. Tienes: ${currentCoins.toLocaleString()} monedas`);
                return;
            }
            
            // Find target player data to check their coins
            const targetPlayerData = players.find(p => p.name === playerName);
            if (!targetPlayerData) {
                alert('Jugador no encontrado');
                return;
            }
            
            if (betAmount > targetPlayerData.coins) {
                alert(`No puedes apostar más de lo que tiene ${playerName}. Tiene: ${targetPlayerData.coins.toLocaleString()} monedas`);
                return;
            }
            
            // Show choice selection modal for attacker
            showChoiceSelectionModal(playerName, betAmount);
        };

        // Show choice selection modal
        function showChoiceSelectionModal(playerName, betAmount) {
            // Create modal for choice selection
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a2e, #16213e);
                    border: 2px solid #FFD700;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    color: #FFD700;
                ">
                    <h2 style="margin-bottom: 20px; color: #FFD700;">🎯 ELIGE TU OPCIÓN</h2>
                    <p style="margin-bottom: 20px; color: #ccc;">
                        Retando a <strong>${playerName}</strong> por <strong>${betAmount.toLocaleString()} monedas</strong>
                    </p>
                    <p style="margin-bottom: 30px; color: #FFD700; font-size: 1.1rem;">
                        Selecciona Piedra, Papel o Tijera:
                    </p>
                    
                    <div style="display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap;">
                        <div class="choice-option" data-choice="piedra" style="
                            width: 100px;
                            height: 100px;
                            background: linear-gradient(135deg, #FFD700, #FFA500);
                            border-radius: 15px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 2.5rem;
                            cursor: pointer;
                            transition: all 0.3s;
                            border: 3px solid transparent;
                        ">🪨</div>
                        <div class="choice-option" data-choice="papel" style="
                            width: 100px;
                            height: 100px;
                            background: linear-gradient(135deg, #FFD700, #FFA500);
                            border-radius: 15px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 2.5rem;
                            cursor: pointer;
                            transition: all 0.3s;
                            border: 3px solid transparent;
                        ">📄</div>
                        <div class="choice-option" data-choice="tijera" style="
                            width: 100px;
                            height: 100px;
                            background: linear-gradient(135deg, #FFD700, #FFA500);
                            border-radius: 15px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 2.5rem;
                            cursor: pointer;
                            transition: all 0.3s;
                            border: 3px solid transparent;
                        ">✂️</div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button id="sendChallengeBtn" style="
                            background: linear-gradient(45deg, #FFD700, #FFA500);
                            color: #1a1a2e;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 1em;
                            font-weight: bold;
                            cursor: pointer;
                            margin-right: 10px;
                            display: none;
                        ">ENVIAR RETO</button>
                        <button onclick="closeChoiceModal()" style="
                            background: linear-gradient(45deg, #f44336, #d32f2f);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 1em;
                            font-weight: bold;
                            cursor: pointer;
                        ">CANCELAR</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners for choice options
            const choiceOptions = modal.querySelectorAll('.choice-option');
            const sendBtn = modal.querySelector('#sendChallengeBtn');
            let selectedChoice = null;
            
            choiceOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove previous selection
                    choiceOptions.forEach(opt => {
                        opt.style.borderColor = 'transparent';
                        opt.style.transform = 'scale(1)';
                    });
                    
                    // Select this option
                    this.style.borderColor = '#FFD700';
                    this.style.transform = 'scale(1.05)';
                    selectedChoice = this.dataset.choice;
                    
                    // Show send button
                    sendBtn.style.display = 'inline-block';
                });
                
                option.addEventListener('mouseenter', function() {
                    if (!this.style.borderColor || this.style.borderColor === 'transparent') {
                        this.style.transform = 'translateY(-5px) scale(1.1)';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (!this.style.borderColor || this.style.borderColor === 'transparent') {
                        this.style.transform = 'scale(1)';
                    }
                });
            });
            
            // Add event listener for send button
            sendBtn.addEventListener('click', function() {
                if (selectedChoice) {
                    sendChallengeWithChoice(playerName, betAmount, selectedChoice);
                    closeChoiceModal();
                }
            });
        }

        // Close choice modal
        window.closeChoiceModal = function() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        };

        // Send challenge with choice
        function sendChallengeWithChoice(playerName, betAmount, choice) {
            // Create challenge with attacker's choice
            const challengeRef = db.ref(`rpsChallenges/${playerName}`);
            challengeRef.set({
                challenger: currentPlayer,
                challenged: playerName,
                betAmount: betAmount,
                challengerChoice: choice, // Attacker's choice is stored
                status: 'pending',
                createdAt: Date.now()
            });

            alert(`Reto enviado a ${playerName} por ${betAmount.toLocaleString()} monedas con tu elección: ${getChoiceEmoji(choice)}`);
        }

        // Show challenge modal (for defender)
        function showChallengeModal(challenge) {
            currentChallenge = challenge;
            document.getElementById('challengeMessage').textContent = 
                `${challenge.challenger} te está retando a Piedra Papel Tijera!`;
            document.getElementById('challengeBetAmount').textContent = 
                `Apuesta: ${challenge.betAmount.toLocaleString()} monedas`;
            document.getElementById('challengeModal').style.display = 'block';
        }

        // Accept challenge (defender chooses their option)
        window.acceptChallenge = function() {
            if (!currentChallenge) return;
            
            // Show choice selection for defender
            showDefenderChoiceModal();
        };

        // Show choice selection modal for defender
        function showDefenderChoiceModal() {
            // Hide challenge modal
            document.getElementById('challengeModal').style.display = 'none';
            
            // Create modal for defender's choice
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a2e, #16213e);
                    border: 2px solid #FFD700;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    color: #FFD700;
                ">
                    <h2 style="margin-bottom: 20px; color: #FFD700;">⚔️ ELIGE TU DEFENSA</h2>
                    <p style="margin-bottom: 20px; color: #ccc;">
                        ${currentChallenge.challenger} te retó por <strong>${currentChallenge.betAmount.toLocaleString()} monedas</strong>
                    </p>
                    <p style="margin-bottom: 30px; color: #FFD700; font-size: 1.1rem;">
                        Selecciona Piedra, Papel o Tijera:
                    </p>
                    
                    <div style="display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap;">
                        <div class="defender-choice" data-choice="piedra" style="
                            width: 100px;
                            height: 100px;
                            background: linear-gradient(135deg, #FFD700, #FFA500);
                            border-radius: 15px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 2.5rem;
                            cursor: pointer;
                            transition: all 0.3s;
                            border: 3px solid transparent;
                        ">🪨</div>
                        <div class="defender-choice" data-choice="papel" style="
                            width: 100px;
                            height: 100px;
                            background: linear-gradient(135deg, #FFD700, #FFA500);
                            border-radius: 15px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 2.5rem;
                            cursor: pointer;
                            transition: all 0.3s;
                            border: 3px solid transparent;
                        ">📄</div>
                        <div class="defender-choice" data-choice="tijera" style="
                            width: 100px;
                            height: 100px;
                            background: linear-gradient(135deg, #FFD700, #FFA500);
                            border-radius: 15px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 2.5rem;
                            cursor: pointer;
                            transition: all 0.3s;
                            border: 3px solid transparent;
                        ">✂️</div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button id="confirmDefenderChoice" style="
                            background: linear-gradient(45deg, #4CAF50, #45a049);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 1em;
                            font-weight: bold;
                            cursor: pointer;
                            margin-right: 10px;
                            display: none;
                        ">CONFIRMAR Y RESOLVER</button>
                        <button onclick="closeDefenderChoiceModal()" style="
                            background: linear-gradient(45deg, #f44336, #d32f2f);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 1em;
                            font-weight: bold;
                            cursor: pointer;
                        ">CANCELAR</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners for defender choice options
            const choiceOptions = modal.querySelectorAll('.defender-choice');
            const confirmBtn = modal.querySelector('#confirmDefenderChoice');
            let selectedChoice = null;
            
            choiceOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove previous selection
                    choiceOptions.forEach(opt => {
                        opt.style.borderColor = 'transparent';
                        opt.style.transform = 'scale(1)';
                    });
                    
                    // Select this option
                    this.style.borderColor = '#FFD700';
                    this.style.transform = 'scale(1.05)';
                    selectedChoice = this.dataset.choice;
                    
                    // Show confirm button
                    confirmBtn.style.display = 'inline-block';
                });
                
                option.addEventListener('mouseenter', function() {
                    if (!this.style.borderColor || this.style.borderColor === 'transparent') {
                        this.style.transform = 'translateY(-5px) scale(1.1)';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (!this.style.borderColor || this.style.borderColor === 'transparent') {
                        this.style.transform = 'scale(1)';
                    }
                });
            });
            
            // Add event listener for confirm button
            confirmBtn.addEventListener('click', function() {
                if (selectedChoice) {
                    resolveChallenge(selectedChoice);
                    closeDefenderChoiceModal();
                }
            });
        }

        // Close defender choice modal
        window.closeDefenderChoiceModal = function() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        };

        // Resolve challenge with both choices
        function resolveChallenge(defenderChoice) {
            const challengerChoice = currentChallenge.challengerChoice;
            const challengerName = currentChallenge.challenger;
            const challengedName = currentChallenge.challenged;
            const betAmount = currentChallenge.betAmount;
            
            const winner = determineWinner(challengerChoice, defenderChoice);
            
            // Show results immediately for defender
            showFinalResults(challengerName, challengedName, challengerChoice, defenderChoice, winner, betAmount);
            
            // Update coins and stats for defender
            if (winner !== 'tie') {
                if ((winner === 'challenger' && currentPlayer === challengerName) || 
                    (winner === 'challenged' && currentPlayer === challengedName)) {
                    // Winner
                    const newCoins = currentCoins + betAmount;
                    localStorage.setItem('totalOrtizCoins', newCoins.toString());
                    currentCoins = newCoins;
                    
                    const userRef = db.ref(`players/${currentPlayer}`);
                    userRef.update({ 
                        coins: newCoins,
                        rpsWins: (parseInt(localStorage.getItem('rpsWins') || '0') + 1).toString()
                    });
                } else {
                    // Loser
                    const newCoins = Math.max(0, currentCoins - betAmount);
                    localStorage.setItem('totalOrtizCoins', newCoins.toString());
                    currentCoins = newCoins;
                    
                    const userRef = db.ref(`players/${currentPlayer}`);
                    userRef.update({ 
                        coins: newCoins,
                        rpsLosses: (parseInt(localStorage.getItem('rpsLosses') || '0') + 1).toString()
                    });
                }
                
                // Update display
                document.getElementById('currentPlayerCoins').textContent = currentCoins.toLocaleString() + ' monedas';
            }
            
            // Save to history
            const historyRef = db.ref('rpsHistory');
            historyRef.push({
                challenger: challengerName,
                challenged: challengedName,
                challengerChoice: challengerChoice,
                challengedChoice: defenderChoice,
                winner: winner,
                betAmount: betAmount,
                timestamp: Date.now()
            });
            
            // Send result to challenger via Firebase
            const resultRef = db.ref(`rpsResults/${challengerName}`);
            resultRef.set({
                challenger: challengerName,
                challenged: challengedName,
                challengerChoice: challengerChoice,
                challengedChoice: defenderChoice,
                winner: winner,
                betAmount: betAmount,
                timestamp: Date.now()
            });
            
            // Clean up challenge
            const challengeRef = db.ref(`rpsChallenges/${challengedName}`);
            challengeRef.remove();
            
            currentChallenge = null;
        }

        // Show final results
        function showFinalResults(challengerName, challengedName, challengerChoice, defenderChoice, winner, betAmount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            let resultText = '';
            if (winner === 'tie') {
                resultText = `🤝 ¡EMPATE! Ambos eligieron ${getChoiceEmoji(challengerChoice)}`;
            } else if (winner === 'challenger') {
                resultText = `🏆 ¡${challengerName} GANA ${betAmount.toLocaleString()} MONEDAS!`;
            } else {
                resultText = `🏆 ¡${challengedName} GANA ${betAmount.toLocaleString()} MONEDAS!`;
            }
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a2e, #16213e);
                    border: 2px solid #FFD700;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 600px;
                    width: 90%;
                    text-align: center;
                    color: #FFD700;
                ">
                    <h2 style="margin-bottom: 20px; color: #FFD700;">⚔️ RESULTADO FINAL</h2>
                    <div style="font-size: 1.5rem; margin-bottom: 30px; color: #FFD700;">
                        ${resultText}
                    </div>
                    
                    <div style="display: flex; justify-content: space-around; gap: 20px; margin: 30px 0;">
                        <div style="
                            flex: 1;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                            background: rgba(255, 255, 255, 0.1);
                            border: 2px solid ${winner === 'challenger' ? '#4CAF50' : '#666'};
                        ">
                            <div style="font-weight: bold; margin-bottom: 10px;">${challengerName}</div>
                            <div style="font-size: 2rem; margin: 10px 0;">${getChoiceEmoji(challengerChoice)}</div>
                            <div style="font-size: 0.9rem; color: #ccc;">${challengerChoice.toUpperCase()}</div>
                        </div>
                        <div style="
                            flex: 1;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                            background: rgba(255, 255, 255, 0.1);
                            border: 2px solid ${winner === 'challenged' ? '#4CAF50' : '#666'};
                        ">
                            <div style="font-weight: bold; margin-bottom: 10px;">${challengedName}</div>
                            <div style="font-size: 2rem; margin: 10px 0;">${getChoiceEmoji(defenderChoice)}</div>
                            <div style="font-size: 0.9rem; color: #ccc;">${defenderChoice.toUpperCase()}</div>
                        </div>
                    </div>
                    
                    <button onclick="closeResultsModal()" style="
                        background: linear-gradient(45deg, #FFD700, #FFA500);
                        color: #1a1a2e;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 1em;
                        font-weight: bold;
                        cursor: pointer;
                    ">CONTINUAR</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                closeResultsModal();
            }, 8000);
        }

        // Close results modal
        window.closeResultsModal = function() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        };

        // Show result to challenger
        function showResultToChallenger(result) {
            const challengerName = result.challenger;
            const challengedName = result.challenged;
            const challengerChoice = result.challengerChoice;
            const challengedChoice = result.challengedChoice;
            const winner = result.winner;
            const betAmount = result.betAmount;
            
            // Update coins and stats for challenger
            if (winner !== 'tie') {
                if (winner === 'challenger') {
                    // Challenger won
                    const newCoins = currentCoins + betAmount;
                    localStorage.setItem('totalOrtizCoins', newCoins.toString());
                    currentCoins = newCoins;
                    
                    const userRef = db.ref(`players/${currentPlayer}`);
                    userRef.update({ 
                        coins: newCoins,
                        rpsWins: (parseInt(localStorage.getItem('rpsWins') || '0') + 1).toString()
                    });
                } else {
                    // Challenger lost
                    const newCoins = Math.max(0, currentCoins - betAmount);
                    localStorage.setItem('totalOrtizCoins', newCoins.toString());
                    currentCoins = newCoins;
                    
                    const userRef = db.ref(`players/${currentPlayer}`);
                    userRef.update({ 
                        coins: newCoins,
                        rpsLosses: (parseInt(localStorage.getItem('rpsLosses') || '0') + 1).toString()
                    });
                }
                
                // Update display
                document.getElementById('currentPlayerCoins').textContent = currentCoins.toLocaleString() + ' monedas';
            }
            
            // Save to history if not already saved
            const historyRef = db.ref('rpsHistory');
            historyRef.orderByChild('timestamp').equalTo(result.timestamp).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        historyRef.push({
                            challenger: result.challenger,
                            challenged: result.challenged,
                            challengerChoice: result.challengerChoice,
                            challengedChoice: result.challengedChoice,
                            winner: result.winner,
                            betAmount: result.betAmount,
                            timestamp: result.timestamp
                        });
                    }
                });
            
            // Show results modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            let resultText = '';
            if (winner === 'tie') {
                resultText = `🤝 ¡EMPATE! Ambos eligieron ${getChoiceEmoji(challengerChoice)}`;
            } else if (winner === 'challenger') {
                resultText = `🏆 ¡GANASTE ${betAmount.toLocaleString()} MONEDAS!`;
            } else {
                resultText = `💸 ¡PERDISTE ${betAmount.toLocaleString()} MONEDAS!`;
            }
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a2e, #16213e);
                    border: 2px solid #FFD700;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 600px;
                    width: 90%;
                    text-align: center;
                    color: #FFD700;
                ">
                    <h2 style="margin-bottom: 20px; color: #FFD700;">⚔️ RESULTADO DE TU RETO</h2>
                    <div style="font-size: 1.5rem; margin-bottom: 30px; color: #FFD700;">
                        ${resultText}
                    </div>
                    
                    <div style="display: flex; justify-content: space-around; gap: 20px; margin: 30px 0;">
                        <div style="
                            flex: 1;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                            background: rgba(255, 255, 255, 0.1);
                            border: 2px solid ${winner === 'challenger' ? '#4CAF50' : '#666'};
                        ">
                            <div style="font-weight: bold; margin-bottom: 10px;">TÚ (${challengerName})</div>
                            <div style="font-size: 2rem; margin: 10px 0;">${getChoiceEmoji(challengerChoice)}</div>
                            <div style="font-size: 0.9rem; color: #ccc;">${challengerChoice.toUpperCase()}</div>
                        </div>
                        <div style="
                            flex: 1;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                            background: rgba(255, 255, 255, 0.1);
                            border: 2px solid ${winner === 'challenged' ? '#4CAF50' : '#666'};
                        ">
                            <div style="font-weight: bold; margin-bottom: 10px;">${challengedName}</div>
                            <div style="font-size: 2rem; margin: 10px 0;">${getChoiceEmoji(challengedChoice)}</div>
                            <div style="font-size: 0.9rem; color: #ccc;">${challengedChoice.toUpperCase()}</div>
                        </div>
                    </div>
                    
                    <button onclick="closeResultsModal()" style="
                        background: linear-gradient(45deg, #FFD700, #FFA500);
                        color: #1a1a2e;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 1em;
                        font-weight: bold;
                        cursor: pointer;
                    ">CONTINUAR</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                closeResultsModal();
            }, 8000);
        }

        // Listen for incoming challenges
        function listenForChallenges() {
            const challengeRef = db.ref(`rpsChallenges/${currentPlayer}`);
            challengeRef.on('value', (snapshot) => {
                const challenge = snapshot.val();
                if (challenge && challenge.status === 'pending') {
                    showChallengeModal(challenge);
                } else if (challenge && challenge.status === 'rejected') {
                    alert(`${challenge.challenger} rechazó tu reto.`);
                    challengeRef.remove();
                }
            });
        }

        // Listen for game results (for challenger)
        function listenForResults() {
            const resultRef = db.ref(`rpsResults/${currentPlayer}`);
            resultRef.on('value', (snapshot) => {
                const result = snapshot.val();
                if (result) {
                    showResultToChallenger(result);
                    resultRef.remove(); // Clean up after showing
                }
            });
        }

        // Reject challenge
        window.rejectChallenge = function() {
            if (!currentChallenge) return;
            
            // Notify challenger
            const challengerRef = db.ref(`rpsChallenges/${currentChallenge.challenger}`);
            challengerRef.set({ status: 'rejected' });
            
            // Remove challenge
            const challengeRef = db.ref(`rpsChallenges/${currentChallenge.challenged}`);
            challengeRef.remove();
            
            // Hide modal
            document.getElementById('challengeModal').style.display = 'none';
            currentChallenge = null;
        };

        // Start game
        function startGame(challenge) {
            gameState = 'playing';
            document.getElementById('gameModal').style.display = 'block';
            
            document.getElementById('challengerName').textContent = challenge.challenger;
            document.getElementById('challengedName').textContent = challenge.challenged;
            document.getElementById('challengeBet').textContent = challenge.betAmount.toLocaleString();
            
            // Listen for game updates
            const gameRef = db.ref(`rpsGames/${challenge.challenger}_${challenge.challenged}`);
            gameRef.on('value', (snapshot) => {
                const gameData = snapshot.val();
                if (gameData) {
                    updateGameState(gameData);
                }
            });
        }

        // Update game state
        function updateGameState(gameData) {
            if (gameData.challengerChoice && gameData.challengedChoice) {
                // Both players have chosen
                showResults(gameData);
            } else if (gameData.challengerChoice && currentPlayer === currentChallenge.challenged) {
                // Opponent chose, now it's my turn
                document.getElementById('waitingMessage').style.display = 'none';
                document.getElementById('choiceMade').style.display = 'none';
            } else if (gameData.challengedChoice && currentPlayer === currentChallenge.challenger) {
                // Opponent chose, now it's my turn
                document.getElementById('waitingMessage').style.display = 'none';
                document.getElementById('choiceMade').style.display = 'none';
            } else {
                // Waiting for opponent
                document.getElementById('waitingMessage').style.display = 'block';
                document.getElementById('choiceMade').style.display = 'none';
            }
        }

        // Select choice
        window.selectChoice = function(choice) {
            if (gameState !== 'playing' || myChoice) return;
            
            // Remove previous selection
            document.querySelectorAll('.rps-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Select new choice
            const selectedOption = document.querySelector(`[data-choice="${choice}"]`);
            selectedOption.classList.add('selected');
            
            myChoice = choice;
            
            // Show confirm button
            document.getElementById('confirmBtn').style.display = 'inline-block';
        };

        // Confirm choice
        window.confirmChoice = function() {
            if (!myChoice) return;
            
            // Save choice to Firebase
            const gameRef = db.ref(`rpsGames/${currentChallenge.challenger}_${currentChallenge.challenged}`);
            if (currentPlayer === currentChallenge.challenger) {
                gameRef.set({ challengerChoice: myChoice });
            } else {
                gameRef.set({ challengedChoice: myChoice });
            }
            
            // Disable options
            document.querySelectorAll('.rps-option').forEach(option => {
                option.style.pointerEvents = 'none';
            });
            
            // Hide confirm button and show waiting message
            document.getElementById('confirmBtn').style.display = 'none';
            document.getElementById('waitingMessage').style.display = 'none';
            document.getElementById('choiceMade').style.display = 'block';
        };

        // Show results
        function showResults(gameData) {
            const challengerChoice = gameData.challengerChoice;
            const challengedChoice = gameData.challengedChoice;
            const challengerName = currentChallenge.challenger;
            const challengedName = currentChallenge.challenged;
            
            const winner = determineWinner(challengerChoice, challengedChoice);
            
            const results = document.getElementById('results');
            const winnerText = document.getElementById('winnerText');
            const scoreBoard = document.getElementById('scoreBoard');
            
            if (winner === 'tie') {
                winnerText.textContent = `🤝 ¡Empate! Ambos eligieron ${getChoiceEmoji(challengerChoice)}`;
            } else if (winner === 'challenger') {
                winnerText.textContent = `🏆 ¡${challengerName} gana ${currentChallenge.betAmount.toLocaleString()} monedas!`;
            } else {
                winnerText.textContent = `🏆 ¡${challengedName} gana ${currentChallenge.betAmount.toLocaleString()} monedas!`;
            }
            
            scoreBoard.innerHTML = `
                <div class="score-card ${winner === 'challenger' ? 'winner' : winner === 'tie' ? 'tie' : 'loser'}">
                    <div class="player-name">${challengerName}</div>
                    <div class="player-choice">${getChoiceEmoji(challengerChoice)}</div>
                    <div class="player-status">${challengerChoice.toUpperCase()}</div>
                </div>
                <div class="score-card ${winner === 'challenged' ? 'winner' : winner === 'tie' ? 'tie' : 'loser'}">
                    <div class="player-name">${challengedName}</div>
                    <div class="player-choice">${getChoiceEmoji(challengedChoice)}</div>
                    <div class="player-status">${challengedChoice.toUpperCase()}</div>
                </div>
            `;
            
            results.style.display = 'block';
            
            // Update coins and stats
            if (winner !== 'tie') {
                if ((winner === 'challenger' && currentPlayer === challengerName) || 
                    (winner === 'challenged' && currentPlayer === challengedName)) {
                    // Winner
                    const newCoins = currentCoins + currentChallenge.betAmount;
                    localStorage.setItem('totalOrtizCoins', newCoins.toString());
                    
                    const userRef = db.ref(`players/${currentPlayer}`);
                    userRef.update({ 
                        totalOrtizCoins: newCoins,
                        rpsWins: (parseInt(localStorage.getItem('rpsWins') || '0') + 1).toString()
                    });
                } else {
                    // Loser
                    const newCoins = Math.max(0, currentCoins - currentChallenge.betAmount);
                    localStorage.setItem('totalOrtizCoins', newCoins.toString());
                    
                    const userRef = db.ref(`players/${currentPlayer}`);
                    userRef.update({ 
                        totalOrtizCoins: newCoins,
                        rpsLosses: (parseInt(localStorage.getItem('rpsLosses') || '0') + 1).toString()
                    });
                }
            }
            
            // Return to lobby after 5 seconds
            setTimeout(() => {
                resetGame();
            }, 5000);
        }

        // Determine winner
        function determineWinner(choice1, choice2) {
            if (choice1 === choice2) return 'tie';
            
            if ((choice1 === 'piedra' && choice2 === 'tijera') ||
                (choice1 === 'papel' && choice2 === 'piedra') ||
                (choice1 === 'tijera' && choice2 === 'papel')) {
                return 'challenger';
            } else {
                return 'challenged';
            }
        }

        // Get choice emoji
        function getChoiceEmoji(choice) {
            const emojis = {
                'piedra': '🪨',
                'papel': '📄',
                'tijera': '✂️'
            };
            return emojis[choice] || '❓';
        }

        // Reset game
        function resetGame() {
            gameState = 'lobby';
            currentChallenge = null;
            myChoice = null;
            
            document.getElementById('gameModal').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('waitingMessage').style.display = 'none';
            document.getElementById('choiceMade').style.display = 'none';
            document.getElementById('confirmBtn').style.display = 'none';
            
            // Reset RPS options
            document.querySelectorAll('.rps-option').forEach(option => {
                option.classList.remove('selected');
                option.style.pointerEvents = 'auto';
            });
            
            // Clean up Firebase
            if (currentChallenge) {
                const gameRef = db.ref(`rpsGames/${currentChallenge.challenger}_${currentChallenge.challenged}`);
                gameRef.remove();
            }
        }

        // Close game
        window.closeGame = function() {
            resetGame();
        };

        // Start listening for challenges
        listenForChallenges();
    </script>
</body>
</html> 